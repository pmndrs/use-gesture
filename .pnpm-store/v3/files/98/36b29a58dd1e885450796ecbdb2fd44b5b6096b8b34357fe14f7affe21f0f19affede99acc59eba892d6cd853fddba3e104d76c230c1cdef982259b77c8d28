{"version":3,"sources":["../../src/utils/feedback.ts"],"names":["feedbackKey","lastDateKey","firstDateKey","sevenDayKey","setFeedbackDisabledValue","enabled","set","showFeedbackRequest","Date","now","name","report","log","showSevenDayFeedbackRequest","randomChanceToBeTrue","currentQuarter","Math","floor","getMonth","randomNumber","random","randomNumberWithinQuarter","userPassesFeedbackRequestHeuristic","randomlyPassingHeuristic","isFeedbackDisabled","lastDateValue","get","lastDate","threeMonthsAgo","setMonth","sevenDayFeedback","sevenDayDate","versionPoints","split","latestVersionPoints","e","versionsMatchOnMajorAndMinor","process","env","GATSBY_FEEDBACK_DISABLED","userGetsSevenDayFeedback","firstDateValue","sevenDaysAgo","setDate","getDate"],"mappings":"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","sourcesContent":["import report from \"gatsby-cli/lib/reporter\"\nimport { getConfigStore, getGatsbyVersion, isCI } from \"gatsby-core-utils\"\nimport { trackCli } from \"gatsby-telemetry\"\nimport latestVersion from \"latest-version\"\nimport getDayOfYear from \"date-fns/getDayOfYear\"\n\nconst feedbackKey = `feedback.disabled`\nconst lastDateKey = `feedback.lastRequestDate`\nconst firstDateKey = `feedback.firstCheckDate`\nconst sevenDayKey = `feedback.sevenDayFeedbackDate`\n\n// This function is designed to be used by `gatsby feedback --disable`\n// and `gatsby feedback --enable`. This key is used to determine\n// if a user is allowed to be solicited for feedback\nexport function setFeedbackDisabledValue(enabled: boolean): void {\n  getConfigStore().set(feedbackKey, enabled)\n}\n\n// Print the feedback request to the user\nexport function showFeedbackRequest(): void {\n  getConfigStore().set(lastDateKey, Date.now())\n  trackCli(`SHOW_FEEDBACK_LINK`, {\n    name: `https://gatsby.dev/feedback`,\n  })\n  report.log(\n    `\\n\\nHello! Will you help Gatsby improve by taking a four question survey?\\nIt takes less than five minutes and your ideas and feedback will be very helpful.`\n  )\n  report.log(`\\nGive us your feedback here: https://gatsby.dev/feedback\\n\\n`)\n}\n\nexport function showSevenDayFeedbackRequest(): void {\n  getConfigStore().set(sevenDayKey, Date.now())\n  trackCli(`SHOW_SEVEN_DAY_FEEDBACK_LINK`, {\n    name: `https://gatsby.dev/feedback-survey`,\n  })\n  report.log(\n    `\\n\\nHi there! Will you tell us about how you're learning Gatsby? \\nIt takes less than 5 minutes and your feedback will help us make installing and using Gatsby so much better.`\n  )\n  report.log(\n    `\\nGive us your feedback here: https://gatsby.dev/feedback-survey\\n\\n`\n  )\n}\n\nconst randomChanceToBeTrue = (): boolean => {\n  // This is spreading the request volume over the quarter.\n  // We are grabbing a randomNumber within the spread of a first day\n  // of a quarter, to the last day\n  const currentQuarter = Math.floor((new Date().getMonth() + 3) / 3)\n  const randomNumber = Math.floor(\n    Math.random() *\n      // One quarter year in days (roughly)\n      (30 * 3)\n  )\n  const randomNumberWithinQuarter = randomNumber + 30 * 3 * (currentQuarter - 1)\n\n  return randomNumberWithinQuarter === getDayOfYear(new Date())\n}\n\n// We are only showing feedback requests to users in if they pass a few checks:\n// 1. They pass a Math.random() check. This is a skateboard version of not sending out all requests in one day.\n// 2. Gatsby is not running in CI\n// 3. They don't have the environment variable to disable feedback present\n// 4. They haven't disabled the feedback mechanism\n// 5. It's been at least 3 months since the last feedback request\n// 6. They are on the most recent version of Gatsby\nexport async function userPassesFeedbackRequestHeuristic(): Promise<boolean> {\n  // Heuristic 1\n  // We originally wrote this to have a single chance of hitting.\n  // We wanted to up the chance by 5x, so this is our crude - temporary -\n  // way of giving the user 5 chances to passing.\n  const randomlyPassingHeuristic =\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue()\n\n  if (!randomlyPassingHeuristic) {\n    return false\n  }\n\n  if (isFeedbackDisabled()) {\n    return false\n  }\n\n  // Heuristic 5\n  const lastDateValue = getConfigStore().get(lastDateKey)\n  // 5.a if the user has never received the feedback request, this is undefined\n  //     Which is effectively a pass, because it's been ~infinity~ since they last\n  //     received a request from us.\n  if (lastDateValue) {\n    const lastDate = new Date(lastDateValue)\n    const threeMonthsAgo = new Date()\n    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3)\n\n    if (lastDate > threeMonthsAgo) {\n      return false\n    }\n  }\n\n  // 5.b\n  // we don't want to give them this survey right after the seven day feedback survey\n  const sevenDayFeedback = getConfigStore().get(sevenDayKey)\n  if (sevenDayFeedback) {\n    const sevenDayDate = new Date(sevenDayFeedback)\n    const threeMonthsAgo = new Date()\n    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3)\n\n    if (sevenDayDate > threeMonthsAgo) {\n      return false\n    }\n  }\n\n  // Heuristic 6\n  const versionPoints = getGatsbyVersion().split(`.`)\n  let latestVersionPoints: Array<string> = []\n  try {\n    latestVersionPoints = (await latestVersion(`gatsby`)).split(`.`)\n  } catch (e) {\n    // do nothing.\n    // if the request fails, then we should just not show the feedback request\n    // because this in theory could happen often and we don't want to be spammy.\n    // In this case, we are guaranteed to have `versionsMatchOnMajorAndMinor` === false\n  }\n\n  // Since we push versions very frequently. So thinking that users will\n  // be on the latest patch is potentially unrealistic. So we are just\n  // comparing on major and minor version points.\n  const versionsMatchOnMajorAndMinor =\n    versionPoints[0] === latestVersionPoints[0] &&\n    versionPoints[1] === latestVersionPoints[1]\n\n  if (versionsMatchOnMajorAndMinor === false) {\n    return false\n  }\n\n  // If all of the above passed, then the user is able to be prompted\n  // for feedback\n  return true\n}\n\nfunction isFeedbackDisabled(): boolean {\n  // Reasoning for this order: Checking for CI fixes issues like\n  // https://github.com/gatsbyjs/gatsby/issues/30647\n  // TODO: Additionally prevent getConfigStore from erroring\n\n  // Heuristic 2\n  if (isCI()) {\n    return true\n  }\n\n  // Heuristic 3\n  if (process.env.GATSBY_FEEDBACK_DISABLED === `1`) {\n    return true\n  }\n\n  // Heuristic 4\n  if (getConfigStore().get(feedbackKey) === true) {\n    return true\n  }\n\n  return false\n}\n\nexport async function userGetsSevenDayFeedback(): Promise<boolean> {\n  if (isFeedbackDisabled()) return false\n\n  if (getConfigStore().get(sevenDayKey)) return false\n\n  const firstDateValue = getConfigStore().get(firstDateKey)\n\n  if (!firstDateValue) {\n    getConfigStore().set(firstDateKey, Date.now()) // set this for the first time\n    return false\n  } else {\n    const lastDate = new Date(firstDateValue)\n    const sevenDaysAgo = new Date()\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)\n\n    if (lastDate > sevenDaysAgo) {\n      return false\n    }\n  }\n  return true\n}\n"],"file":"feedback.js"}