{"version":3,"sources":["../../src/utils/gatsby-dependents.ts"],"names":["getAllDependencies","pkg","Set","Object","entries","dependencies","devDependencies","optionalDependencies","readJSON","file","buffer","JSON","parse","toString","getTreeFromNodeModules","dir","results","Map","requireFromHere","packageJSON","require","resolve","error","Promise","all","Array","from","map","name","version","currentDependency","path","test","has","set","values","getGatsbyDependents","program","store","getState","directory"],"mappings":";;;;;AAAA;;AACA;;AAEA;;AACA;;AAEA;;AAQA,MAAMA,kBAAkB,GAAIC,GAAD,IACzB,IAAIC,GAAJ,CAAQ,CACN,GAAGC,MAAM,CAACC,OAAP,CAAeH,GAAG,CAACI,YAAJ,IAAoB,EAAnC,CADG,EAEN,GAAGF,MAAM,CAACC,OAAP,CAAeH,GAAG,CAACK,eAAJ,IAAuB,EAAtC,CAFG,EAGN,GAAGH,MAAM,CAACC,OAAP,CAAeH,GAAG,CAACM,oBAAJ,IAA4B,EAA3C,CAHG,CAAR,CADF;;AAOA,MAAMC,QAAQ,GAAG,MAAOC,IAAP,IAA8C;AAC7D,QAAMC,MAAM,GAAG,MAAM,uBAASD,IAAT,CAArB;AACA,SAAOE,IAAI,CAACC,KAAL,CAAWF,MAAM,CAACG,QAAP,EAAX,CAAP;AACD,CAHD;;AAKA,MAAMC,sBAAsB,GAAG,OAC7BC,GAD6B,EAE7BC,OAAiC,GAAG,IAAIC,GAAJ,EAFP,KAGG;AAChC,QAAMC,eAAe,GAAG,4CAAuB,GAAEH,GAAI,aAA7B,CAAxB;AACA,MAAII,WAAJ;;AACA,MAAI;AACFA,IAAAA,WAAW,GAAG,MAAMX,QAAQ,CAACY,OAAO,CAACC,OAAR,CAAgB,gBAAKN,GAAL,EAAW,cAAX,CAAhB,CAAD,CAA5B;AACD,GAFD,CAEE,OAAOO,KAAP,EAAc;AACdH,IAAAA,WAAW,GAAG,EAAd;AACD;;AAED,QAAMI,OAAO,CAACC,GAAR,CACJC,KAAK,CAACC,IAAN,CAAW1B,kBAAkB,CAACmB,WAAD,CAA7B,EAA4CQ,GAA5C,CAAgD,OAAO,CAACC,IAAD,EAAOC,OAAP,CAAP,KAA2B;AACzE,QAAI;AACF,YAAMC,iBAA8B,GAAG;AACrCF,QAAAA,IADqC;AAErCC,QAAAA,OAFqC;AAGrCE,QAAAA,IAAI,EAAE,mBAAQb,eAAe,CAACG,OAAhB,CAAyB,GAAEO,IAAK,eAAhC,CAAR;AAH+B,OAAvC,CADE,CAOF;;AACA,UACE,SAASI,IAAT,CAAcF,iBAAiB,CAACF,IAAhC,KACAE,iBAAiB,CAACF,IAAlB,KAA4B,QAF9B,EAGE;AACA,cAAMd,sBAAsB,CAACgB,iBAAiB,CAACC,IAAnB,EAAyBf,OAAzB,CAA5B;AACA,YAAI,CAACA,OAAO,CAACiB,GAAR,CAAYH,iBAAiB,CAACF,IAA9B,CAAL,EACEZ,OAAO,CAACkB,GAAR,CAAYJ,iBAAiB,CAACF,IAA9B,EAAoCE,iBAApC;AACH;AACF,KAhBD,CAgBE,OAAOR,KAAP,EAAc,CACd;AACA;AACD;AACF,GArBD,CADI,CAAN;AAyBA,SAAOG,KAAK,CAACC,IAAN,CAAWV,OAAO,CAACmB,MAAR,EAAX,CAAP;AACD,CAtCD;;AAwCO,MAAMC,mBAAmB,GAAG,qBACjC,YAAyC;AACvC,QAAM;AAAEC,IAAAA;AAAF,MAAcC,aAAMC,QAAN,EAApB;;AACA,SAAOzB,sBAAsB,CAACuB,OAAO,CAACG,SAAT,CAA7B;AACD,CAJgC,CAA5B","sourcesContent":["import { store } from \"../redux\"\nimport { memoize } from \"lodash\"\n\nimport { createRequireFromPath } from \"gatsby-core-utils\"\nimport { join, dirname } from \"path\"\nimport { PackageJson } from \"../..\"\nimport { readFile } from \"fs-extra\"\n\ninterface IDependency {\n  name: string\n  version: string\n  path: string\n}\n\nconst getAllDependencies = (pkg: PackageJson): Set<[string, string]> =>\n  new Set([\n    ...Object.entries(pkg.dependencies || {}),\n    ...Object.entries(pkg.devDependencies || {}),\n    ...Object.entries(pkg.optionalDependencies || {}),\n  ])\n\nconst readJSON = async (file: string): Promise<PackageJson> => {\n  const buffer = await readFile(file)\n  return JSON.parse(buffer.toString())\n}\n\nconst getTreeFromNodeModules = async (\n  dir: string,\n  results: Map<string, IDependency> = new Map()\n): Promise<Array<IDependency>> => {\n  const requireFromHere = createRequireFromPath(`${dir}/:internal:`)\n  let packageJSON: PackageJson\n  try {\n    packageJSON = await readJSON(require.resolve(join(dir, `package.json`)))\n  } catch (error) {\n    packageJSON = {}\n  }\n\n  await Promise.all(\n    Array.from(getAllDependencies(packageJSON)).map(async ([name, version]) => {\n      try {\n        const currentDependency: IDependency = {\n          name,\n          version,\n          path: dirname(requireFromHere.resolve(`${name}/package.json`)),\n        }\n\n        // Include anything that has `gatsby` in its name but not `gatsby` itself\n        if (\n          /gatsby/.test(currentDependency.name) &&\n          currentDependency.name !== `gatsby`\n        ) {\n          await getTreeFromNodeModules(currentDependency.path, results)\n          if (!results.has(currentDependency.name))\n            results.set(currentDependency.name, currentDependency)\n        }\n      } catch (error) {\n        // Sometimes dev dependencies of dependencies aren't installed\n        // when using `yarn`. This is okay and safe to ignore.\n      }\n    })\n  )\n\n  return Array.from(results.values())\n}\n\nexport const getGatsbyDependents = memoize(\n  async (): Promise<Array<IDependency>> => {\n    const { program } = store.getState()\n    return getTreeFromNodeModules(program.directory)\n  }\n)\n"],"file":"gatsby-dependents.js"}