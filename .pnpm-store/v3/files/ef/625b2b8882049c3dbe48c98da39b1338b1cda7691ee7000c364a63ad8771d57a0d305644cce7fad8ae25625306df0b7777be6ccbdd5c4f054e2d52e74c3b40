"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@babel/runtime/helpers/defineProperty"),e=require("three");function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=s(t);class o extends e.EventDispatcher{constructor(t,s,o){super(),i.default(this,"enabled",!0),i.default(this,"transformGroup",!1),i.default(this,"_objects",void 0),i.default(this,"_camera",void 0),i.default(this,"_domElement",void 0),i.default(this,"_plane",new e.Plane),i.default(this,"_raycaster",new e.Raycaster),i.default(this,"_mouse",new e.Vector2),i.default(this,"_offset",new e.Vector3),i.default(this,"_intersection",new e.Vector3),i.default(this,"_worldPosition",new e.Vector3),i.default(this,"_inverseMatrix",new e.Matrix4),i.default(this,"_intersections",[]),i.default(this,"_selected",null),i.default(this,"_hovered",null),i.default(this,"activate",(()=>{this._domElement.addEventListener("pointermove",this.onPointerMove),this._domElement.addEventListener("pointerdown",this.onPointerDown),this._domElement.addEventListener("pointerup",this.onPointerCancel),this._domElement.addEventListener("pointerleave",this.onPointerCancel),this._domElement.addEventListener("touchmove",this.onTouchMove),this._domElement.addEventListener("touchstart",this.onTouchStart),this._domElement.addEventListener("touchend",this.onTouchEnd)})),i.default(this,"deactivate",(()=>{this._domElement.removeEventListener("pointermove",this.onPointerMove),this._domElement.removeEventListener("pointerdown",this.onPointerDown),this._domElement.removeEventListener("pointerup",this.onPointerCancel),this._domElement.removeEventListener("pointerleave",this.onPointerCancel),this._domElement.removeEventListener("touchmove",this.onTouchMove),this._domElement.removeEventListener("touchstart",this.onTouchStart),this._domElement.removeEventListener("touchend",this.onTouchEnd),this._domElement.style.cursor=""})),i.default(this,"dispose",(()=>this.deactivate())),i.default(this,"getObjects",(()=>this._objects)),i.default(this,"onMouseMove",(t=>{const e=this._domElement.getBoundingClientRect();if(this._mouse.x=(t.clientX-e.left)/e.width*2-1,this._mouse.y=-(t.clientY-e.top)/e.height*2+1,this._raycaster.setFromCamera(this._mouse,this._camera),this._selected&&this.enabled)return this._raycaster.ray.intersectPlane(this._plane,this._intersection)&&this._selected.position.copy(this._intersection.sub(this._offset).applyMatrix4(this._inverseMatrix)),void this.dispatchEvent({type:"drag",object:this._selected});if(this._intersections.length=0,this._raycaster.setFromCamera(this._mouse,this._camera),this._raycaster.intersectObjects(this._objects,!0,this._intersections),this._intersections.length>0){const t=this._intersections[0].object;this._plane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._plane.normal),this._worldPosition.setFromMatrixPosition(t.matrixWorld)),this._hovered!==t&&(this.dispatchEvent({type:"hoveron",object:t}),this._domElement.style.cursor="pointer",this._hovered=t)}else null!==this._hovered&&(this.dispatchEvent({type:"hoveroff",object:this._hovered}),this._domElement.style.cursor="auto",this._hovered=null)})),i.default(this,"onMouseDown",(()=>{this._intersections.length=0,this._raycaster.setFromCamera(this._mouse,this._camera),this._raycaster.intersectObjects(this._objects,!0,this._intersections),this._intersections.length>0&&(this._selected=!0===this.transformGroup?this._objects[0]:this._intersections[0].object,this._raycaster.ray.intersectPlane(this._plane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._offset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))),this._domElement.style.cursor="move",this.dispatchEvent({type:"dragstart",object:this._selected}))})),i.default(this,"onMouseCancel",(()=>{this._selected&&(this.dispatchEvent({type:"dragend",object:this._selected}),this._selected=null),this._domElement.style.cursor=this._hovered?"pointer":"auto"})),i.default(this,"onPointerMove",(t=>{switch(t.pointerType){case"mouse":case"pen":this.onMouseMove(t)}})),i.default(this,"onPointerDown",(t=>{switch(t.pointerType){case"mouse":case"pen":this.onMouseDown()}})),i.default(this,"onPointerCancel",(t=>{switch(t.pointerType){case"mouse":case"pen":this.onMouseCancel()}})),i.default(this,"onTouchMove",(t=>{t.preventDefault();const e=t.changedTouches[0],s=this._domElement.getBoundingClientRect();if(this._mouse.x=(e.clientX-s.left)/s.width*2-1,this._mouse.y=-(e.clientY-s.top)/s.height*2+1,this._raycaster.setFromCamera(this._mouse,this._camera),this._selected&&this.enabled)return this._raycaster.ray.intersectPlane(this._plane,this._intersection)&&this._selected.position.copy(this._intersection.sub(this._offset).applyMatrix4(this._inverseMatrix)),void this.dispatchEvent({type:"drag",object:this._selected})})),i.default(this,"onTouchStart",(t=>{t.preventDefault();const e=t.changedTouches[0],s=this._domElement.getBoundingClientRect();this._mouse.x=(e.clientX-s.left)/s.width*2-1,this._mouse.y=-(e.clientY-s.top)/s.height*2+1,this._intersections.length=0,this._raycaster.setFromCamera(this._mouse,this._camera),this._raycaster.intersectObjects(this._objects,!0,this._intersections),this._intersections.length>0&&(this._selected=!0===this.transformGroup?this._objects[0]:this._intersections[0].object,this._plane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._plane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._plane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._offset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))),this._domElement.style.cursor="move",this.dispatchEvent({type:"dragstart",object:this._selected}))})),i.default(this,"onTouchEnd",(t=>{t.preventDefault(),this._selected&&(this.dispatchEvent({type:"dragend",object:this._selected}),this._selected=null),this._domElement.style.cursor="auto"})),this._objects=t,this._camera=s,this._domElement=o,this.activate()}}exports.DragControls=o;
