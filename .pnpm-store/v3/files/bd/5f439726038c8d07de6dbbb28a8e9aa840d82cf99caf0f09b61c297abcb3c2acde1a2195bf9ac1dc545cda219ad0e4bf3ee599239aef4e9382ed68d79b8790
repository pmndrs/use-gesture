"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("chevrotain");class n extends e.Loader{constructor(e){super(e)}load(t,n,r,o){const a=this,s=""===a.path?e.LoaderUtils.extractUrlBase(t):a.path,l=new e.FileLoader(a.manager);l.setPath(a.path),l.setRequestHeader(a.requestHeader),l.setWithCredentials(a.withCredentials),l.load(t,(function(e){try{n(a.parse(e,s))}catch(e){o?o(e):console.error(e),a.manager.itemError(t)}}),r,o)}parse(n,l){const i={};function c(e){e.DEF&&(i[e.DEF]=e);const t=e.fields;for(let e=0,n=t.length;e<n;e++){const n=t[e];if("node"===n.type){const e=n.values;for(let t=0,n=e.length;t<n;t++)c(e[t])}}}function u(t){return t.USE?function(e){const t=u(i[e]);return t.isObject3D||t.isMaterial?t.clone():t}(t.USE):(void 0!==t.build||(t.build=function(t){const n=t.name;let r;switch(n){case"Group":case"Transform":case"Collision":r=function(t){const n=new e.Group,r=t.fields;for(let t=0,o=r.length;t<o;t++){const o=r[t],a=o.name,s=o.values;switch(a){case"bboxCenter":case"bboxSize":case"center":break;case"children":p(s,n);break;case"collide":break;case"rotation":const t=new e.Vector3(s[0],s[1],s[2]),r=s[3];n.quaternion.setFromAxisAngle(t,r);break;case"scale":n.scale.set(s[0],s[1],s[2]);break;case"scaleOrientation":break;case"translation":n.position.set(s[0],s[1],s[2]);break;case"proxy":break;default:console.warn("THREE.VRMLLoader: Unknown field:",a)}}return n}(t);break;case"Background":r=function(t){const n=new e.Group;let r,o,a,s;const l=t.fields;for(let e=0,t=l.length;e<t;e++){const t=l[e],n=t.name,i=t.values;switch(n){case"groundAngle":r=i;break;case"groundColor":o=i;break;case"backUrl":case"bottomUrl":case"frontUrl":case"leftUrl":case"rightUrl":case"topUrl":break;case"skyAngle":a=i;break;case"skyColor":s=i;break;default:console.warn("THREE.VRMLLoader: Unknown field:",n)}}const i=1e4;if(s){const t=new e.SphereGeometry(i,32,16),r=new e.MeshBasicMaterial({fog:!1,side:e.BackSide,depthWrite:!1,depthTest:!1});s.length>3?(N(t,i,a,I(s),!0),r.vertexColors=!0):r.color.setRGB(s[0],s[1],s[2]);const o=new e.Mesh(t,r);n.add(o)}if(o&&o.length>0){const t=new e.SphereGeometry(i,32,16,0,2*Math.PI,.5*Math.PI,1.5*Math.PI),a=new e.MeshBasicMaterial({fog:!1,side:e.BackSide,vertexColors:!0,depthWrite:!1,depthTest:!1});N(t,i,r,I(o),!1);const s=new e.Mesh(t,a);n.add(s)}return n.renderOrder=-1/0,n}(t);break;case"Shape":r=function(t){const n=t.fields;let r,o,a=new e.MeshBasicMaterial({color:0});for(let e=0,t=n.length;e<t;e++){const t=n[e],o=t.name,s=t.values;switch(o){case"appearance":null!==s[0]&&(a=u(s[0]));break;case"geometry":null!==s[0]&&(r=u(s[0]));break;default:console.warn("THREE.VRMLLoader: Unknown field:",o)}}if(r&&r.attributes.position){const t=r._type;if("points"===t){const t=new e.PointsMaterial({color:16777215});void 0!==r.attributes.color?t.vertexColors=!0:a.isMeshPhongMaterial&&t.color.copy(a.emissive),o=new e.Points(r,t)}else if("line"===t){const t=new e.LineBasicMaterial({color:16777215});void 0!==r.attributes.color?t.vertexColors=!0:a.isMeshPhongMaterial&&t.color.copy(a.emissive),o=new e.LineSegments(r,t)}else void 0!==r._solid&&(a.side=r._solid?e.FrontSide:e.DoubleSide),void 0!==r.attributes.color&&(a.vertexColors=!0),o=new e.Mesh(r,a)}else o=new e.Object3D,o.visible=!1;return o}(t);break;case"Appearance":r=function(t){let n,r=new e.MeshPhongMaterial;const o=t.fields;for(let t=0,a=o.length;t<a;t++){const a=o[t],s=a.name,l=a.values;switch(s){case"material":if(null!==l[0]){const e=u(l[0]);e.diffuseColor&&r.color.copy(e.diffuseColor),e.emissiveColor&&r.emissive.copy(e.emissiveColor),e.shininess&&(r.shininess=e.shininess),e.specularColor&&r.specular.copy(e.specularColor),e.transparency&&(r.opacity=1-e.transparency),e.transparency>0&&(r.transparent=!0)}else r=new e.MeshBasicMaterial({color:0});break;case"texture":const t=l[0];null!==t&&("ImageTexture"!==t.name&&"PixelTexture"!==t.name||(r.map=u(t)));break;case"textureTransform":null!==l[0]&&(n=u(l[0]));break;default:console.warn("THREE.VRMLLoader: Unknown field:",s)}}if(r.map){if(r.map.__type){switch(r.map.__type){case s.INTENSITY_ALPHA:r.opacity=1;break;case s.RGB:r.color.set(16777215);break;case s.RGBA:r.color.set(16777215),r.opacity=1}delete r.map.__type}n&&(r.map.center.copy(n.center),r.map.rotation=n.rotation,r.map.repeat.copy(n.scale),r.map.offset.copy(n.translation))}return r}(t);break;case"Material":r=function(t){const n={},r=t.fields;for(let t=0,o=r.length;t<o;t++){const o=r[t],a=o.name,s=o.values;switch(a){case"ambientIntensity":break;case"diffuseColor":n.diffuseColor=new e.Color(s[0],s[1],s[2]);break;case"emissiveColor":n.emissiveColor=new e.Color(s[0],s[1],s[2]);break;case"shininess":n.shininess=s[0];break;case"specularColor":n.emissiveColor=new e.Color(s[0],s[1],s[2]);break;case"transparency":n.transparency=s[0];break;default:console.warn("THREE.VRMLLoader: Unknown field:",a)}}return n}(t);break;case"ImageTexture":r=function(t){let n,r=e.RepeatWrapping,o=e.RepeatWrapping;const a=t.fields;for(let t=0,s=a.length;t<s;t++){const s=a[t],l=s.name,i=s.values;switch(l){case"url":const t=i[0];t&&(n=B.load(t));break;case"repeatS":!1===i[0]&&(r=e.ClampToEdgeWrapping);break;case"repeatT":!1===i[0]&&(o=e.ClampToEdgeWrapping);break;default:console.warn("THREE.VRMLLoader: Unknown field:",l)}}n&&(n.wrapS=r,n.wrapT=o);return n}(t);break;case"PixelTexture":r=function(t){let n,r=e.RepeatWrapping,o=e.RepeatWrapping;const a=t.fields;for(let t=0,s=a.length;t<s;t++){const s=a[t],l=s.name,i=s.values;switch(l){case"image":const t=i[0],a=i[1],s=i[2],c=2===s||4===s,u=d(s),p=new Uint8Array(t*a*(!0===c?4:3)),h={r:0,g:0,b:0,a:0};for(let e=3,t=0,n=i.length;e<n;e++,t++)if(f(i[e],u,h),!0===c){const e=4*t;p[e+0]=h.r,p[e+1]=h.g,p[e+2]=h.b,p[e+3]=h.a}else{const e=3*t;p[e+0]=h.r,p[e+1]=h.g,p[e+2]=h.b}n=new e.DataTexture(p,t,a,!0===c?e.RGBAFormat:e.RGBFormat),n.__type=u;break;case"repeatS":!1===i[0]&&(r=e.ClampToEdgeWrapping);break;case"repeatT":!1===i[0]&&(o=e.ClampToEdgeWrapping);break;default:console.warn("THREE.VRMLLoader: Unknown field:",l)}}n&&(n.wrapS=r,n.wrapT=o);return n}(t);break;case"TextureTransform":r=function(t){const n={center:new e.Vector2,rotation:new e.Vector2,scale:new e.Vector2,translation:new e.Vector2},r=t.fields;for(let e=0,t=r.length;e<t;e++){const t=r[e],o=t.name,a=t.values;switch(o){case"center":n.center.set(a[0],a[1]);break;case"rotation":n.rotation=a[0];break;case"scale":n.scale.set(a[0],a[1]);break;case"translation":n.translation.set(a[0],a[1]);break;default:console.warn("THREE.VRMLLoader: Unknown field:",o)}}return n}(t);break;case"IndexedFaceSet":r=function(t){let n,r,o,a,s,l,i,c,f=!0,d=!0,p=0,m=!0,g=!0;const k=t.fields;for(let e=0,t=k.length;e<t;e++){const t=k[e],h=t.name,b=t.values;switch(h){case"color":const e=b[0];null!==e&&(n=u(e));break;case"coord":const t=b[0];null!==t&&(r=u(t));break;case"normal":const x=b[0];null!==x&&(o=u(x));break;case"texCoord":const k=b[0];null!==k&&(a=u(k));break;case"ccw":f=b[0];break;case"colorIndex":s=b;break;case"colorPerVertex":m=b[0];break;case"convex":break;case"coordIndex":l=b;break;case"creaseAngle":p=b[0];break;case"normalIndex":i=b;break;case"normalPerVertex":g=b[0];break;case"solid":d=b[0];break;case"texCoordIndex":c=b;break;default:console.warn("THREE.VRMLLoader: Unknown field:",h)}}if(void 0===l)return console.warn("THREE.VRMLLoader: Missing coordIndex."),new e.BufferGeometry;const w=h(l,f);let L,E,y;if(n)if(!0===m)if(s&&s.length>0){L=S(w,h(s,f),n,3)}else L=U(w,new e.Float32BufferAttribute(n,3));else if(s&&s.length>0){L=A(w,b(x(n,s),l))}else{L=A(w,b(n,l))}if(o)if(!0===g)if(i&&i.length>0){E=S(w,h(i,f),o,3)}else E=U(w,new e.Float32BufferAttribute(o,3));else if(i&&i.length>0){E=A(w,b(x(o,i),l))}else{E=A(w,b(o,l))}else E=v(w,r,p);if(a)if(c&&c.length>0){y=S(w,h(c,f),a,2)}else y=U(w,new e.Float32BufferAttribute(a,2));const T=new e.BufferGeometry,R=U(w,new e.Float32BufferAttribute(r,3));T.setAttribute("position",R),T.setAttribute("normal",E),L&&T.setAttribute("color",L);y&&T.setAttribute("uv",y);return T._solid=d,T._type="mesh",T}(t);break;case"IndexedLineSet":r=function(t){let n,r,o,a,s=!0;const l=t.fields;for(let e=0,t=l.length;e<t;e++){const t=l[e],i=t.name,c=t.values;switch(i){case"color":const e=c[0];null!==e&&(n=u(e));break;case"coord":const t=c[0];null!==t&&(r=u(t));break;case"colorIndex":o=c;break;case"colorPerVertex":s=c[0];break;case"coordIndex":a=c;break;default:console.warn("THREE.VRMLLoader: Unknown field:",i)}}let i;const c=m(a);if(n)if(!0===s)if(o.length>0){i=S(c,m(o),n,3)}else i=U(c,new e.Float32BufferAttribute(n,3));else if(o.length>0){i=R(c,g(x(n,o),a))}else{i=R(c,g(n,a))}const f=new e.BufferGeometry,d=U(c,new e.Float32BufferAttribute(r,3));f.setAttribute("position",d),i&&f.setAttribute("color",i);return f._type="line",f}(t);break;case"PointSet":r=function(t){let n,r;const o=t.fields;for(let e=0,t=o.length;e<t;e++){const t=o[e],a=t.name,s=t.values;switch(a){case"color":const e=s[0];null!==e&&(n=u(e));break;case"coord":const t=s[0];null!==t&&(r=u(t));break;default:console.warn("THREE.VRMLLoader: Unknown field:",a)}}const a=new e.BufferGeometry;a.setAttribute("position",new e.Float32BufferAttribute(r,3)),n&&a.setAttribute("color",new e.Float32BufferAttribute(n,3));return a._type="points",a}(t);break;case"Box":r=function(t){const n=new e.Vector3(2,2,2),r=t.fields;for(let e=0,t=r.length;e<t;e++){const t=r[e],o=t.name,a=t.values;switch(o){case"size":n.x=a[0],n.y=a[1],n.z=a[2];break;default:console.warn("THREE.VRMLLoader: Unknown field:",o)}}return new e.BoxGeometry(n.x,n.y,n.z)}(t);break;case"Cone":r=function(t){let n=1,r=2,o=!1;const a=t.fields;for(let e=0,t=a.length;e<t;e++){const t=a[e],s=t.name,l=t.values;switch(s){case"bottom":o=!l[0];break;case"bottomRadius":n=l[0];break;case"height":r=l[0];break;case"side":break;default:console.warn("THREE.VRMLLoader: Unknown field:",s)}}return new e.ConeGeometry(n,r,16,1,o)}(t);break;case"Cylinder":r=function(t){let n=1,r=2;const o=t.fields;for(let e=0,t=o.length;e<t;e++){const t=o[e],a=t.name,s=t.values;switch(a){case"bottom":break;case"radius":n=s[0];break;case"height":r=s[0];break;case"side":case"top":break;default:console.warn("THREE.VRMLLoader: Unknown field:",a)}}return new e.CylinderGeometry(n,n,r,16,1)}(t);break;case"Sphere":r=function(t){let n=1;const r=t.fields;for(let e=0,t=r.length;e<t;e++){const t=r[e],o=t.name,a=t.values;switch(o){case"radius":n=a[0];break;default:console.warn("THREE.VRMLLoader: Unknown field:",o)}}return new e.SphereGeometry(n,16,16)}(t);break;case"ElevationGrid":r=function(t){let n,r,o,a,s=!0,l=!0,i=!0,c=!0,f=0,d=2,p=2,h=1,b=1;const x=t.fields;for(let e=0,t=x.length;e<t;e++){const t=x[e],m=t.name,g=t.values;switch(m){case"color":const e=g[0];null!==e&&(n=u(e));break;case"normal":const t=g[0];null!==t&&(r=u(t));break;case"texCoord":const x=g[0];null!==x&&(o=u(x));break;case"height":a=g;break;case"ccw":c=g[0];break;case"colorPerVertex":s=g[0];break;case"creaseAngle":f=g[0];break;case"normalPerVertex":l=g[0];break;case"solid":i=g[0];break;case"xDimension":d=g[0];break;case"xSpacing":h=g[0];break;case"zDimension":p=g[0];break;case"zSpacing":b=g[0];break;default:console.warn("THREE.VRMLLoader: Unknown field:",m)}}const m=[],g=[],k=[],w=[];for(let e=0;e<p;e++)for(let t=0;t<d;t++){const i=e*d+t,c=h*e,u=a[i],f=b*t;if(m.push(c,u,f),n&&!0===s){const e=n[3*i+0],t=n[3*i+1],r=n[3*i+2];k.push(e,t,r)}if(r&&!0===l){const e=r[3*i+0],t=r[3*i+1],n=r[3*i+2];g.push(e,t,n)}if(o){const e=o[2*i+0],t=o[2*i+1];w.push(e,t)}else w.push(e/(d-1),t/(p-1))}const L=[];for(let e=0;e<d-1;e++)for(let t=0;t<p-1;t++){const n=e+t*d,r=e+(t+1)*d,o=e+1+(t+1)*d,a=e+1+t*d;!0===c?(L.push(n,o,r),L.push(o,n,a)):(L.push(n,r,o),L.push(o,a,n))}const E=U(L,new e.Float32BufferAttribute(m,3)),y=U(L,new e.Float32BufferAttribute(w,2));let T,S;if(n)if(!1===s){for(let e=0;e<d-1;e++)for(let t=0;t<p-1;t++){const r=e+t*(d-1),o=n[3*r+0],a=n[3*r+1],s=n[3*r+2];k.push(o,a,s),k.push(o,a,s),k.push(o,a,s),k.push(o,a,s),k.push(o,a,s),k.push(o,a,s)}T=new e.Float32BufferAttribute(k,3)}else T=U(L,new e.Float32BufferAttribute(k,3));if(r)if(!1===l){for(let e=0;e<d-1;e++)for(let t=0;t<p-1;t++){const n=e+t*(d-1),o=r[3*n+0],a=r[3*n+1],s=r[3*n+2];g.push(o,a,s),g.push(o,a,s),g.push(o,a,s),g.push(o,a,s),g.push(o,a,s),g.push(o,a,s)}S=new e.Float32BufferAttribute(g,3)}else S=U(L,new e.Float32BufferAttribute(g,3));else S=v(L,m,f);const A=new e.BufferGeometry;A.setAttribute("position",E),A.setAttribute("normal",S),A.setAttribute("uv",y),T&&A.setAttribute("color",T);return A._solid=i,A._type="mesh",A}(t);break;case"Extrusion":r=function(t){let n,r,o=[1,1,1,-1,-1,-1,-1,1,1,1],a=[0,0,0,0,1,0],s=!0,l=!0,i=0,c=!0,u=!0;const f=t.fields;for(let e=0,t=f.length;e<t;e++){const t=f[e],d=t.name,p=t.values;switch(d){case"beginCap":s=p[0];break;case"ccw":l=p[0];break;case"convex":break;case"creaseAngle":i=p[0];break;case"crossSection":o=p;break;case"endCap":c=p[0];break;case"orientation":r=p;break;case"scale":n=p;break;case"solid":u=p[0];break;case"spine":a=p;break;default:console.warn("THREE.VRMLLoader: Unknown field:",d)}}const d=o[0]===o[o.length-2]&&o[1]===o[o.length-1],p=[],h=new e.Vector3,b=new e.Vector3,x=new e.Vector3,m=new e.Vector3,g=new e.Quaternion;for(let e=0,t=0,s=0,l=a.length;e<l;e+=3,t+=2,s+=4){h.fromArray(a,e),b.x=n?n[t+0]:1,b.y=1,b.z=n?n[t+1]:1,x.x=r?r[s+0]:0,x.y=r?r[s+1]:0,x.z=r?r[s+2]:1;const l=r?r[s+3]:0;for(let e=0,t=o.length;e<t;e+=2)m.x=o[e+0],m.y=0,m.z=o[e+1],m.multiply(b),g.setFromAxisAngle(x,l),m.applyQuaternion(g),m.add(h),p.push(m.x,m.y,m.z)}const k=[],w=a.length/3,L=o.length/2;for(let e=0;e<w-1;e++)for(let t=0;t<L-1;t++){const n=t+e*L;let r=t+1+e*L;const o=t+(e+1)*L;let a=t+1+(e+1)*L;t===L-2&&!0===d&&(r=e*L,a=(e+1)*L),!0===l?(k.push(n,r,o),k.push(o,r,a)):(k.push(n,o,r),k.push(o,a,r))}if(!0===s||!0===c){const t=[];for(let n=0,r=o.length;n<r;n+=2)t.push(new e.Vector2(o[n],o[n+1]));const n=e.ShapeUtils.triangulateShape(t,[]),r=[];for(let e=0,t=n.length;e<t;e++){const t=n[e];r.push(t[0],t[1],t[2])}if(!0===s)for(let e=0,t=r.length;e<t;e+=3)!0===l?k.push(r[e+0],r[e+1],r[e+2]):k.push(r[e+0],r[e+2],r[e+1]);if(!0===c){const e=L*(w-1);for(let t=0,n=r.length;t<n;t+=3)!0===l?k.push(e+r[t+0],e+r[t+2],e+r[t+1]):k.push(e+r[t+0],e+r[t+1],e+r[t+2])}}const E=U(k,new e.Float32BufferAttribute(p,3)),y=v(k,p,i),T=new e.BufferGeometry;return T.setAttribute("position",E),T.setAttribute("normal",y),T._solid=u,T._type="mesh",T}(t);break;case"Color":case"Coordinate":case"Normal":case"TextureCoordinate":r=function(e){return e.fields[0].values}(t);break;case"WorldInfo":r=function(e){const t={},n=e.fields;for(let e=0,r=n.length;e<r;e++){const r=n[e],o=r.name,a=r.values;switch(o){case"title":t.title=a[0];break;case"info":t.info=a;break;default:console.warn("THREE.VRMLLoader: Unknown field:",o)}}return t}(t);break;case"Anchor":case"Billboard":case"Inline":case"LOD":case"Switch":case"AudioClip":case"DirectionalLight":case"PointLight":case"Script":case"Sound":case"SpotLight":case"CylinderSensor":case"PlaneSensor":case"ProximitySensor":case"SphereSensor":case"TimeSensor":case"TouchSensor":case"VisibilitySensor":case"Text":case"FontStyle":case"MovieTexture":case"ColorInterpolator":case"CoordinateInterpolator":case"NormalInterpolator":case"OrientationInterpolator":case"PositionInterpolator":case"ScalarInterpolator":case"Fog":case"NavigationInfo":case"Viewpoint":break;default:console.warn("THREE.VRMLLoader: Unknown node:",n)}void 0!==r&&void 0!==t.DEF&&!0===r.hasOwnProperty("name")&&(r.name=t.DEF);return r}(t)),t.build)}function f(e,t,n){let r;switch(t){case s.INTENSITY:r=parseInt(e),n.r=r,n.g=r,n.b=r;break;case s.INTENSITY_ALPHA:r=parseInt("0x"+e.substring(2,4)),n.r=r,n.g=r,n.b=r,n.a=parseInt("0x"+e.substring(4,6));break;case s.RGB:n.r=parseInt("0x"+e.substring(2,4)),n.g=parseInt("0x"+e.substring(4,6)),n.b=parseInt("0x"+e.substring(6,8));break;case s.RGBA:n.r=parseInt("0x"+e.substring(2,4)),n.g=parseInt("0x"+e.substring(4,6)),n.b=parseInt("0x"+e.substring(6,8)),n.a=parseInt("0x"+e.substring(8,10))}}function d(e){let t;switch(e){case 1:t=s.INTENSITY;break;case 2:t=s.INTENSITY_ALPHA;break;case 3:t=s.RGB;break;case 4:t=s.RGBA}return t}function p(t,n){for(let r=0,o=t.length;r<o;r++){const o=u(t[r]);o instanceof e.Object3D&&n.add(o)}}function h(e,t){const n=[];let r=0;for(let o=0,a=e.length;o<a;o++){const s=e[r],l=e[o+(t?1:2)],i=e[o+(t?2:1)];n.push(s,l,i),(-1===e[o+3]||o+3>=a)&&(o+=3,r=o+1)}return n}function b(e,t){const n=[];let r=0;for(let o=0,a=t.length;o<a;o++){const s=3*r,l=e[s],i=e[s+1],c=e[s+2];n.push(l,i,c),(-1===t[o+3]||o+3>=a)&&(o+=3,r++)}return n}function x(e,t){const n=[];for(let r=0,o=t.length;r<o;r++){const o=3*t[r],a=e[o],s=e[o+1],l=e[o+2];n.push(a,s,l)}return n}function m(e){const t=[];for(let n=0,r=e.length;n<r;n++){const o=e[n],a=e[n+1];t.push(o,a),(-1===e[n+2]||n+2>=r)&&(n+=2)}return t}function g(e,t){const n=[];let r=0;for(let o=0,a=t.length;o<a;o++){const s=3*r,l=e[s],i=e[s+1],c=e[s+2];n.push(l,i,c),(-1===t[o+2]||o+2>=a)&&(o+=2,r++)}return n}const k=new e.Vector3,w=new e.Vector3,L=new e.Vector3,E=new e.Vector2,y=new e.Vector2,T=new e.Vector2;function S(t,n,r,o){const a=[];for(let e=0,s=t.length;e<s;e+=3){const t=n[e],s=n[e+1],l=n[e+2];2===o?(E.fromArray(r,t*o),y.fromArray(r,s*o),T.fromArray(r,l*o),a.push(E.x,E.y),a.push(y.x,y.y),a.push(T.x,T.y)):(k.fromArray(r,t*o),w.fromArray(r,s*o),L.fromArray(r,l*o),a.push(k.x,k.y,k.z),a.push(w.x,w.y,w.z),a.push(L.x,L.y,L.z))}return new e.Float32BufferAttribute(a,o)}function A(t,n){const r=[];for(let e=0,o=0,a=t.length;e<a;e+=3,o++)k.fromArray(n,3*o),r.push(k.x,k.y,k.z),r.push(k.x,k.y,k.z),r.push(k.x,k.y,k.z);return new e.Float32BufferAttribute(r,3)}function R(t,n){const r=[];for(let e=0,o=0,a=t.length;e<a;e+=2,o++)k.fromArray(n,3*o),r.push(k.x,k.y,k.z),r.push(k.x,k.y,k.z);return new e.Float32BufferAttribute(r,3)}function U(t,n){const r=n.array,o=n.itemSize,a=new r.constructor(t.length*o);let s=0,l=0;for(let e=0,n=t.length;e<n;e++){s=t[e]*o;for(let e=0;e<o;e++)a[l++]=r[s++]}return new e.Float32BufferAttribute(a,o)}const C=new e.Vector3,M=new e.Vector3;function v(t,n,r){const o=[],s={};for(let e=0,r=t.length;e<r;e+=3){const r=t[e],l=t[e+1],i=t[e+2],c=new a(r,l,i);k.fromArray(n,3*r),w.fromArray(n,3*l),L.fromArray(n,3*i),M.subVectors(L,w),C.subVectors(k,w),M.cross(C),M.normalize(),c.normal.copy(M),void 0===s[r]&&(s[r]=[]),void 0===s[l]&&(s[l]=[]),void 0===s[i]&&(s[i]=[]),s[r].push(c.normal),s[l].push(c.normal),s[i].push(c.normal),o.push(c)}const l=[];for(let e=0,t=o.length;e<t;e++){const t=o[e],a=V(s[t.a],t.normal,r),i=V(s[t.b],t.normal,r),c=V(s[t.c],t.normal,r);k.fromArray(n,3*t.a),w.fromArray(n,3*t.b),L.fromArray(n,3*t.c),l.push(a.x,a.y,a.z),l.push(i.x,i.y,i.z),l.push(c.x,c.y,c.z)}return new e.Float32BufferAttribute(l,3)}function V(t,n,r){const o=new e.Vector3;if(0===r)o.copy(n);else for(let e=0,a=t.length;e<a;e++)t[e].angleTo(n)<r&&o.add(t[e]);return o.normalize()}function I(t){const n=[];for(let r=0,o=t.length;r<o;r+=3)n.push(new e.Color(t[r],t[r+1],t[r+2]));return n}function N(t,n,r,o,a){const s=[],l=!0===a?0:Math.PI;for(let t=0,i=o.length;t<i;t++){let o=0===t?0:r[t-1];o=!0===a?o:l-o;const i=new e.Vector3;i.setFromSphericalCoords(n,o,0),s.push(i)}const i=t.index,c=t.attributes.position,u=new e.BufferAttribute(new Float32Array(3*t.attributes.position.count),3),f=new e.Vector3,d=new e.Color;for(let e=0;e<i.count;e++){const t=i.getX(e);let n,r;f.fromBufferAttribute(c,t);let l=1;for(let e=1;e<s.length;e++){n=e-1,r=e;const t=s[n],o=s[r];if(!0===a){if(f.y<=t.y&&f.y>o.y){l=Math.abs(t.y-f.y)/Math.abs(t.y-o.y);break}}else if(f.y>=t.y&&f.y<o.y){l=Math.abs(t.y-f.y)/Math.abs(t.y-o.y);break}}const p=o[n],h=o[r];d.copy(p).lerp(h,l),u.setXYZ(t,d.r,d.g,d.b)}t.setAttribute("color",u)}const B=new e.TextureLoader(this.manager);if(B.setPath(this.resourcePath||l).setCrossOrigin(this.crossOrigin),-1===n.indexOf("#VRML V2.0"))throw Error("THREE.VRMLLexer: Version of VRML asset not supported.");return function(t){const n=t.nodes,r=new e.Scene;for(let e=0,t=n.length;e<t;e++){c(n[e])}for(let t=0,o=n.length;t<o;t++){const o=n[t],a=u(o);a instanceof e.Object3D&&r.add(a),"WorldInfo"===o.name&&(r.userData.worldInfo=a)}return r}(function(e){const n=function(){const e=t.createToken({name:"RouteIdentifier",pattern:/[^\x30-\x39\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d][^\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d]*[\.][^\x30-\x39\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d][^\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d]*/}),n=t.createToken({name:"Identifier",pattern:/[^\x30-\x39\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d][^\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d]*/,longer_alt:e}),r=["Anchor","Billboard","Collision","Group","Transform","Inline","LOD","Switch","AudioClip","DirectionalLight","PointLight","Script","Shape","Sound","SpotLight","WorldInfo","CylinderSensor","PlaneSensor","ProximitySensor","SphereSensor","TimeSensor","TouchSensor","VisibilitySensor","Box","Cone","Cylinder","ElevationGrid","Extrusion","IndexedFaceSet","IndexedLineSet","PointSet","Sphere","Color","Coordinate","Normal","TextureCoordinate","Appearance","FontStyle","ImageTexture","Material","MovieTexture","PixelTexture","TextureTransform","ColorInterpolator","CoordinateInterpolator","NormalInterpolator","OrientationInterpolator","PositionInterpolator","ScalarInterpolator","Background","Fog","NavigationInfo","Viewpoint","Text"],o=t.createToken({name:"Version",pattern:/#VRML.*/,longer_alt:n}),a=t.createToken({name:"NodeName",pattern:new RegExp(r.join("|")),longer_alt:n}),s=t.createToken({name:"DEF",pattern:/DEF/,longer_alt:n}),l=t.createToken({name:"USE",pattern:/USE/,longer_alt:n}),i=t.createToken({name:"ROUTE",pattern:/ROUTE/,longer_alt:n}),c=t.createToken({name:"TO",pattern:/TO/,longer_alt:n}),u=t.createToken({name:"StringLiteral",pattern:/"(:?[^\\"\n\r]+|\\(:?[bfnrtv"\\/]|u[0-9a-fA-F]{4}))*"/}),f=t.createToken({name:"HexLiteral",pattern:/0[xX][0-9a-fA-F]+/}),d=t.createToken({name:"NumberLiteral",pattern:/[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?/}),p=t.createToken({name:"TrueLiteral",pattern:/TRUE/}),h=t.createToken({name:"FalseLiteral",pattern:/FALSE/}),b=t.createToken({name:"NullLiteral",pattern:/NULL/}),x=t.createToken({name:"LSquare",pattern:/\[/}),m=t.createToken({name:"RSquare",pattern:/]/}),g=t.createToken({name:"LCurly",pattern:/{/}),k=t.createToken({name:"RCurly",pattern:/}/}),w=t.createToken({name:"Comment",pattern:/#.*/,group:t.Lexer.SKIPPED}),L=[t.createToken({name:"WhiteSpace",pattern:/[ ,\s]/,group:t.Lexer.SKIPPED}),a,s,l,i,c,p,h,b,o,n,e,u,f,d,x,m,g,k,w],E={};for(let e=0,t=L.length;e<t;e++){const t=L[e];E[t.name]=t}return{tokens:L,tokenVocabulary:E}}(),a=new r(n.tokens),s=new o(n.tokenVocabulary),l=function(e){function t(){e.call(this),this.validateVisitor()}function n(e,t){const n={type:null,values:[]};if(t.node){n.type="node";for(let r=0,o=t.node.length;r<o;r++){const o=t.node[r];n.values.push(e.visit(o))}}if(t.use){n.type="use";for(let r=0,o=t.use.length;r<o;r++){const o=t.use[r];n.values.push(e.visit(o))}}if(t.StringLiteral){n.type="string";for(let e=0,r=t.StringLiteral.length;e<r;e++){const r=t.StringLiteral[e];n.values.push(r.image.replace(/'|"/g,""))}}if(t.NumberLiteral){n.type="number";for(let e=0,r=t.NumberLiteral.length;e<r;e++){const r=t.NumberLiteral[e];n.values.push(parseFloat(r.image))}}if(t.HexLiteral){n.type="hex";for(let e=0,r=t.HexLiteral.length;e<r;e++){const r=t.HexLiteral[e];n.values.push(r.image)}}if(t.TrueLiteral){n.type="boolean";for(let e=0,r=t.TrueLiteral.length;e<r;e++){"TRUE"===t.TrueLiteral[e].image&&n.values.push(!0)}}if(t.FalseLiteral){n.type="boolean";for(let e=0,r=t.FalseLiteral.length;e<r;e++){"FALSE"===t.FalseLiteral[e].image&&n.values.push(!1)}}return t.NullLiteral&&(n.type="null",t.NullLiteral.forEach((function(){n.values.push(null)}))),n}return t.prototype=Object.assign(Object.create(e.prototype),{constructor:t,vrml:function(e){const t={version:this.visit(e.version),nodes:[],routes:[]};for(let n=0,r=e.node.length;n<r;n++){const r=e.node[n];t.nodes.push(this.visit(r))}if(e.route)for(let n=0,r=e.route.length;n<r;n++){const r=e.route[n];t.routes.push(this.visit(r))}return t},version:function(e){return e.Version[0].image},node:function(e){const t={name:e.NodeName[0].image,fields:[]};if(e.field)for(let n=0,r=e.field.length;n<r;n++){const r=e.field[n];t.fields.push(this.visit(r))}return e.def&&(t.DEF=this.visit(e.def[0])),t},field:function(e){const t={name:e.Identifier[0].image,type:null,values:null};let n;return e.singleFieldValue&&(n=this.visit(e.singleFieldValue[0])),e.multiFieldValue&&(n=this.visit(e.multiFieldValue[0])),t.type=n.type,t.values=n.values,t},def:function(e){return(e.Identifier||e.NodeName)[0].image},use:function(e){return{USE:(e.Identifier||e.NodeName)[0].image}},singleFieldValue:function(e){return n(this,e)},multiFieldValue:function(e){return n(this,e)},route:function(e){return{FROM:e.RouteIdentifier[0].image,TO:e.RouteIdentifier[1].image}}}),new t}(s.getBaseCstVisitorConstructor()),i=a.lex(e);s.input=i.tokens;const c=s.vrml();if(s.errors.length>0)throw console.error(s.errors),Error("THREE.VRMLLoader: Parsing errors detected.");return l.visit(c)}(n))}}class r{constructor(e){this.lexer=new t.Lexer(e)}lex(e){const t=this.lexer.tokenize(e);if(t.errors.length>0)throw console.error(t.errors),Error("THREE.VRMLLexer: Lexing errors detected.");return t}}class o extends t.CstParser{constructor(e){super(e);const t=this,n=e.Version,r=e.LCurly,o=e.RCurly,a=e.LSquare,s=e.RSquare,l=e.Identifier,i=e.RouteIdentifier,c=e.StringLiteral,u=e.HexLiteral,f=e.NumberLiteral,d=e.TrueLiteral,p=e.FalseLiteral,h=e.NullLiteral,b=e.DEF,x=e.USE,m=e.ROUTE,g=e.TO,k=e.NodeName;t.RULE("vrml",(function(){t.SUBRULE(t.version),t.AT_LEAST_ONE((function(){t.SUBRULE(t.node)})),t.MANY((function(){t.SUBRULE(t.route)}))})),t.RULE("version",(function(){t.CONSUME(n)})),t.RULE("node",(function(){t.OPTION((function(){t.SUBRULE(t.def)})),t.CONSUME(k),t.CONSUME(r),t.MANY((function(){t.SUBRULE(t.field)})),t.CONSUME(o)})),t.RULE("field",(function(){t.CONSUME(l),t.OR2([{ALT:function(){t.SUBRULE(t.singleFieldValue)}},{ALT:function(){t.SUBRULE(t.multiFieldValue)}}])})),t.RULE("def",(function(){t.CONSUME(b),t.OR([{ALT:function(){t.CONSUME(l)}},{ALT:function(){t.CONSUME(k)}}])})),t.RULE("use",(function(){t.CONSUME(x),t.OR([{ALT:function(){t.CONSUME(l)}},{ALT:function(){t.CONSUME(k)}}])})),t.RULE("singleFieldValue",(function(){t.AT_LEAST_ONE((function(){t.OR([{ALT:function(){t.SUBRULE(t.node)}},{ALT:function(){t.SUBRULE(t.use)}},{ALT:function(){t.CONSUME(c)}},{ALT:function(){t.CONSUME(u)}},{ALT:function(){t.CONSUME(f)}},{ALT:function(){t.CONSUME(d)}},{ALT:function(){t.CONSUME(p)}},{ALT:function(){t.CONSUME(h)}}])}))})),t.RULE("multiFieldValue",(function(){t.CONSUME(a),t.MANY((function(){t.OR([{ALT:function(){t.SUBRULE(t.node)}},{ALT:function(){t.SUBRULE(t.use)}},{ALT:function(){t.CONSUME(c)}},{ALT:function(){t.CONSUME(u)}},{ALT:function(){t.CONSUME(f)}},{ALT:function(){t.CONSUME(h)}}])})),t.CONSUME(s)})),t.RULE("route",(function(){t.CONSUME(m),t.CONSUME(i),t.CONSUME(g),t.CONSUME2(i)})),this.performSelfAnalysis()}}class a{constructor(t,n,r){this.a=t,this.b=n,this.c=r,this.normal=new e.Vector3}}const s={INTENSITY:1,INTENSITY_ALPHA:2,RGB:3,RGBA:4};exports.VRMLLoader=n;
