{"version":3,"sources":["../../src/schema/node-model.js"],"names":["_","require","isAbstractType","GraphQLOutputType","GraphQLUnionType","GraphQLList","getNamedType","getNullableType","isCompositeType","invariant","reporter","LocalNodeModel","constructor","schema","schemaComposer","createPageDependency","createPageDependencyActionCreator","_rootNodeMap","WeakMap","_trackedRootNodes","WeakSet","_prepareNodesQueues","_prepareNodesPromises","_preparedNodesCache","Map","replaceFiltersCache","createPageDependencyArgs","connection","nodeTypeNames","toNodeTypeNames","forEach","typeName","map","_filtersCache","withContext","context","ContextualNodeModel","getNodeById","args","pageDependencies","id","type","node","result","includes","internal","trackInlineObjectsInRootNode","trackPageDependencies","getNodesByIds","ids","nodes","Array","isArray","filter","Boolean","length","getAllNodes","nodesByType","concat","connectionType","name","runQuery","firstOnly","findOne","skip","limit","query","findAll","from","entries","_query","stats","tracer","gqlType","getType","materializationActivity","phantomActivity","parentSpan","getParentActivity","span","start","fields","getQueryFields","sort","group","distinct","max","min","sum","fieldsToResolve","determineResolvableFields","nodeTypeName","gqlNodeType","prepareNodes","end","runQueryActivity","totalCount","queryArgs","gqlSchema","gqlComposer","resolvedFields","filtersCache","warn","undefined","first","queryFields","push","Promise","resolve","process","nextTick","_doResolvePrepareNodesQueue","queue","reduce","nextQueryFields","nextFieldsToResolve","merge","actualFieldsToResolve","deepObjectDifference","get","isEmpty","resolvedNodes","iterateNodesByType","resolveRecursive","__gatsby_resolved","set","size","saveResolvedNodes","getTypes","has","addRootNodeToInlineObject","Set","add","findRootNodeAncestor","obj","predicate","iterations","parent","trackedParent","isMatchingRoot","error","path","track","nodeId","rootNodeModel","nodeModel","_getFullDependencies","gqlTypeName","possibleTypes","getPossibleTypes","getInterfaces","some","iface","filterFields","dropQueryOperators","sortFields","pathToObject","split","reduceRight","acc","key","Object","keys","value","k","v","isPlainObject","getFields","concreteType","resolveType","gqlFields","fieldName","fieldToResolve","queryField","gqlField","gqlNonNullType","gqlFieldType","innerValue","resolveField","isObject","all","item","pickBy","withResolverContext","arg","defaultValue","returnType","isNestedType","field","typeComposer","getAnyTC","possibleTCs","needsResolve","tc","getFieldExtension","innerResolved","rootNodeMap","data","isNode","each","o","store","dispatch","payload","to","toValue","deepResult","module","exports"],"mappings":";;AAcA;;AACA;;AAOA;;AApBA,MAAMA,CAAC,GAAGC,OAAO,CAAE,QAAF,CAAjB;;AACA,MAAM;AACJC,EAAAA,cADI;AAEJC,EAAAA,iBAFI;AAGJC,EAAAA,gBAHI;AAIJC,EAAAA,WAJI;AAKJC,EAAAA,YALI;AAMJC,EAAAA,eANI;AAOJC,EAAAA;AAPI,IAQFP,OAAO,CAAE,SAAF,CARX;;AASA,MAAMQ,SAAS,GAAGR,OAAO,CAAE,WAAF,CAAzB;;AACA,MAAMS,QAAQ,GAAGT,OAAO,CAAE,yBAAF,CAAxB;;AAyDA,MAAMU,cAAN,CAAqB;AACnBC,EAAAA,WAAW,CAAC;AAAEC,IAAAA,MAAF;AAAUC,IAAAA,cAAV;AAA0BC,IAAAA;AAA1B,GAAD,EAAmD;AAC5D,SAAKF,MAAL,GAAcA,MAAd;AACA,SAAKC,cAAL,GAAsBA,cAAtB;AACA,SAAKE,iCAAL,GAAyCD,oBAAzC;AAEA,SAAKE,YAAL,GAAoB,IAAIC,OAAJ,EAApB;AACA,SAAKC,iBAAL,GAAyB,IAAIC,OAAJ,EAAzB;AACA,SAAKC,mBAAL,GAA2B,EAA3B;AACA,SAAKC,qBAAL,GAA6B,EAA7B;AACA,SAAKC,mBAAL,GAA2B,IAAIC,GAAJ,EAA3B;AACA,SAAKC,mBAAL;AACD;;AAEDV,EAAAA,oBAAoB,CAACW,wBAAD,EAA2B;AAC7C,QAAIA,wBAAwB,CAACC,UAA7B,EAAyC;AACvC,YAAMC,aAAa,GAAGC,eAAe,CACnC,KAAKhB,MAD8B,EAEnCa,wBAAwB,CAACC,UAFU,CAArC;;AAIA,UAAIC,aAAJ,EAAmB;AACjBA,QAAAA,aAAa,CAACE,OAAd,CAAsBC,QAAQ,IAAI;AAChC,eAAKf,iCAAL,CAAuC,EACrC,GAAGU,wBADkC;AAErCC,YAAAA,UAAU,EAAEI;AAFyB,WAAvC;AAID,SALD;AAMA;AACD;AACF;;AAED,SAAKf,iCAAL,CAAuCU,wBAAvC;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACED,EAAAA,mBAAmB,CAACO,GAAG,GAAG,IAAIR,GAAJ,EAAP,EAAkB;AACnC,SAAKS,aAAL,GAAqBD,GAArB,CADmC,CACV;AAC1B;;AAEDE,EAAAA,WAAW,CAACC,OAAD,EAAU;AACnB,WAAO,IAAIC,mBAAJ,CAAwB,IAAxB,EAA8BD,OAA9B,CAAP;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACEE,EAAAA,WAAW,CAACC,IAAD,EAAOC,gBAAP,EAAyB;AAClC,UAAM;AAAEC,MAAAA,EAAF;AAAMC,MAAAA;AAAN,QAAeH,IAAI,IAAI,EAA7B;AAEA,UAAMI,IAAI,GAAGL,WAAW,CAACG,EAAD,CAAxB;AAEA,QAAIG,MAAJ;;AACA,QAAI,CAACD,IAAL,EAAW;AACTC,MAAAA,MAAM,GAAG,IAAT;AACD,KAFD,MAEO,IAAI,CAACF,IAAL,EAAW;AAChBE,MAAAA,MAAM,GAAGD,IAAT;AACD,KAFM,MAEA;AACL,YAAMd,aAAa,GAAGC,eAAe,CAAC,KAAKhB,MAAN,EAAc4B,IAAd,CAArC;AACAE,MAAAA,MAAM,GAAGf,aAAa,CAACgB,QAAd,CAAuBF,IAAI,CAACG,QAAL,CAAcJ,IAArC,IAA6CC,IAA7C,GAAoD,IAA7D;AACD;;AAED,QAAIC,MAAJ,EAAY;AACV,WAAKG,4BAAL,CAAkCJ,IAAlC;AACD;;AAED,WAAO,KAAKK,qBAAL,CAA2BJ,MAA3B,EAAmCJ,gBAAnC,CAAP;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACES,EAAAA,aAAa,CAACV,IAAD,EAAOC,gBAAP,EAAyB;AACpC,UAAM;AAAEU,MAAAA,GAAF;AAAOR,MAAAA;AAAP,QAAgBH,IAAI,IAAI,EAA9B;AAEA,UAAMY,KAAK,GAAGC,KAAK,CAACC,OAAN,CAAcH,GAAd,IACVA,GAAG,CAACjB,GAAJ,CAAQQ,EAAE,IAAIH,WAAW,CAACG,EAAD,CAAzB,EAA+Ba,MAA/B,CAAsCC,OAAtC,CADU,GAEV,EAFJ;AAIA,QAAIX,MAAJ;;AACA,QAAI,CAACO,KAAK,CAACK,MAAP,IAAiB,CAACd,IAAtB,EAA4B;AAC1BE,MAAAA,MAAM,GAAGO,KAAT;AACD,KAFD,MAEO;AACL,YAAMtB,aAAa,GAAGC,eAAe,CAAC,KAAKhB,MAAN,EAAc4B,IAAd,CAArC;AACAE,MAAAA,MAAM,GAAGO,KAAK,CAACG,MAAN,CAAaX,IAAI,IAAId,aAAa,CAACgB,QAAd,CAAuBF,IAAI,CAACG,QAAL,CAAcJ,IAArC,CAArB,CAAT;AACD;;AAED,QAAIE,MAAJ,EAAY;AACVA,MAAAA,MAAM,CAACb,OAAP,CAAeY,IAAI,IAAI,KAAKI,4BAAL,CAAkCJ,IAAlC,CAAvB;AACD;;AAED,WAAO,KAAKK,qBAAL,CAA2BJ,MAA3B,EAAmCJ,gBAAnC,CAAP;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACEiB,EAAAA,WAAW,CAAClB,IAAD,EAAOC,gBAAgB,GAAG,EAA1B,EAA8B;AACvC;AACA,UAAM;AAAEE,MAAAA,IAAI,GAAI;AAAV,QAAoBH,IAAI,IAAI,EAAlC;AAEA,QAAIK,MAAJ;;AACA,QAAIF,IAAI,KAAM,MAAd,EAAqB;AACnBE,MAAAA,MAAM,GAAG,0BAAT;AACD,KAFD,MAEO;AACL,YAAMf,aAAa,GAAGC,eAAe,CAAC,KAAKhB,MAAN,EAAc4B,IAAd,CAArC;AACA,YAAMgB,WAAW,GAAG7B,aAAa,CAACI,GAAd,CAAkBD,QAAQ,IAC5C,+BAAeA,QAAf,CADkB,CAApB;AAGA,YAAMmB,KAAK,GAAG,GAAGQ,MAAH,CAAU,GAAGD,WAAb,CAAd;AACAd,MAAAA,MAAM,GAAGO,KAAK,CAACG,MAAN,CAAaC,OAAb,CAAT;AACD;;AAED,QAAIX,MAAJ,EAAY;AACVA,MAAAA,MAAM,CAACb,OAAP,CAAeY,IAAI,IAAI,KAAKI,4BAAL,CAAkCJ,IAAlC,CAAvB;AACD;;AAED,QAAI,OAAOH,gBAAgB,CAACoB,cAAxB,KAA4C,WAAhD,EAA4D;AAC1DpB,MAAAA,gBAAgB,CAACoB,cAAjB,GACE,OAAOlB,IAAP,KAAiB,QAAjB,GAA2BA,IAA3B,GAAkCA,IAAI,CAACmB,IADzC;AAED;;AAED,WAAO,KAAKb,qBAAL,CAA2BJ,MAA3B,EAAmCJ,gBAAnC,CAAP;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACgB,QAARsB,QAAQ,CAACvB,IAAD,EAAOC,gBAAgB,GAAG,EAA1B,EAA8B;AAC1C;AACA;AACA;AACA;AACA,QAAID,IAAI,CAACwB,SAAT,EAAoB;AAClB,aAAO,KAAKC,OAAL,CAAazB,IAAb,EAAmBC,gBAAnB,CAAP;AACD;;AACD,UAAM;AAAEyB,MAAAA,IAAF;AAAQC,MAAAA,KAAR;AAAe,SAAGC;AAAlB,QAA4B5B,IAAI,CAAC4B,KAAvC;AACA,UAAMvB,MAAM,GAAG,MAAM,KAAKwB,OAAL,CAAa,EAAE,GAAG7B,IAAL;AAAW4B,MAAAA;AAAX,KAAb,EAAiC3B,gBAAjC,CAArB;AACA,WAAOY,KAAK,CAACiB,IAAN,CAAWzB,MAAM,CAAC0B,OAAlB,CAAP;AACD;;AAEW,QAANC,MAAM,CAAChC,IAAD,EAAO;AACjB,UAAM;AAAE4B,MAAAA,KAAF;AAASzB,MAAAA,IAAT;AAAe8B,MAAAA,KAAf;AAAsBC,MAAAA;AAAtB,QAAiClC,IAAI,IAAI,EAA/C,CADiB,CAGjB;AACA;;AACA,UAAMmC,OAAO,GAAG,OAAOhC,IAAP,KAAiB,QAAjB,GAA2B,KAAK5B,MAAL,CAAY6D,OAAZ,CAAoBjC,IAApB,CAA3B,GAAuDA,IAAvE;AACAhC,IAAAA,SAAS,CACP,EAAEgE,OAAO,YAAYrE,gBAArB,CADO,EAEN,+CAFM,CAAT;AAKA,UAAMwB,aAAa,GAAGC,eAAe,CAAC,KAAKhB,MAAN,EAAc4D,OAAd,CAArC;AAEA,QAAIE,uBAAJ;;AACA,QAAIH,MAAJ,EAAY;AACVG,MAAAA,uBAAuB,GAAGjE,QAAQ,CAACkE,eAAT,CAA0B,iBAA1B,EAA4C;AACpEC,QAAAA,UAAU,EAAEL,MAAM,CAACM,iBAAP,GAA2BC;AAD6B,OAA5C,CAA1B;AAGAJ,MAAAA,uBAAuB,CAACK,KAAxB;AACD;;AACD,UAAMC,MAAM,GAAGC,cAAc,CAAC;AAC5B7B,MAAAA,MAAM,EAAEa,KAAK,CAACb,MADc;AAE5B8B,MAAAA,IAAI,EAAEjB,KAAK,CAACiB,IAFgB;AAG5BC,MAAAA,KAAK,EAAElB,KAAK,CAACkB,KAHe;AAI5BC,MAAAA,QAAQ,EAAEnB,KAAK,CAACmB,QAJY;AAK5BC,MAAAA,GAAG,EAAEpB,KAAK,CAACoB,GALiB;AAM5BC,MAAAA,GAAG,EAAErB,KAAK,CAACqB,GANiB;AAO5BC,MAAAA,GAAG,EAAEtB,KAAK,CAACsB;AAPiB,KAAD,CAA7B;AASA,UAAMC,eAAe,GAAGC,yBAAyB,CAC/C,KAAK5E,cAD0C,EAE/C,KAAKD,MAF0C,EAG/C4D,OAH+C,EAI/CQ,MAJ+C,EAK/CrD,aAL+C,CAAjD;;AAQA,SAAK,MAAM+D,YAAX,IAA2B/D,aAA3B,EAA0C;AACxC,YAAMgE,WAAW,GAAG,KAAK/E,MAAL,CAAY6D,OAAZ,CAAoBiB,YAApB,CAApB;AACA,YAAM,KAAKE,YAAL,CAAkBD,WAAlB,EAA+BX,MAA/B,EAAuCQ,eAAvC,CAAN;AACD;;AAED,QAAId,uBAAJ,EAA6B;AAC3BA,MAAAA,uBAAuB,CAACmB,GAAxB;AACD;;AAED,QAAIC,gBAAJ;;AACA,QAAIvB,MAAJ,EAAY;AACVuB,MAAAA,gBAAgB,GAAGrF,QAAQ,CAACkE,eAAT,CAA0B,UAA1B,EAAqC;AACtDC,QAAAA,UAAU,EAAEL,MAAM,CAACM,iBAAP,GAA2BC;AADe,OAArC,CAAnB;AAGAgB,MAAAA,gBAAgB,CAACf,KAAjB;AACD;;AAED,UAAM;AAAEX,MAAAA,OAAF;AAAW2B,MAAAA;AAAX,QAA0B,MAAM,+BAAenC,QAAf,CAAwB;AAC5DoC,MAAAA,SAAS,EAAE/B,KADiD;AAE5DgC,MAAAA,SAAS,EAAE,KAAKrF,MAF4C;AAG5DsF,MAAAA,WAAW,EAAE,KAAKrF,cAH0C;AAI5D2D,MAAAA,OAJ4D;AAK5D2B,MAAAA,cAAc,EAAEX,eAL4C;AAM5D7D,MAAAA,aAN4D;AAO5DyE,MAAAA,YAAY,EAAE,KAAKpE,aAPyC;AAQ5DsC,MAAAA;AAR4D,KAAxB,CAAtC;;AAWA,QAAIwB,gBAAJ,EAAsB;AACpBA,MAAAA,gBAAgB,CAACD,GAAjB;AACD;;AAED,WAAO;AACLrB,MAAAA,OADK;AAELJ,MAAAA,OAAO,EAAEA,OAAO,CAACrC,GAAR,CAAYU,IAAI,IAAI;AAC3B;AACA,aAAKI,4BAAL,CAAkCJ,IAAlC;AACA,eAAOA,IAAP;AACD,OAJQ,CAFJ;AAOLsD,MAAAA;AAPK,KAAP;AASD;;AAEY,QAAP7B,OAAO,CAAC7B,IAAD,EAAOC,gBAAgB,GAAG,EAA1B,EAA8B;AACzC;AACA,UAAM;AAAEkC,MAAAA,OAAF;AAAW,SAAG9B;AAAd,QAAyB,MAAM,KAAK2B,MAAL,CAAYhC,IAAZ,EAAkBC,gBAAlB,CAArC,CAFyC,CAIzC;;AACA,QAAI,OAAOA,gBAAgB,CAACoB,cAAxB,KAA4C,WAAhD,EAA4D;AAC1DpB,MAAAA,gBAAgB,CAACoB,cAAjB,GAAkCc,OAAO,CAACb,IAA1C;AACD;;AACD,SAAKb,qBAAL,CAA2BJ,MAAM,CAAC0B,OAAlC,EAA2C9B,gBAA3C;AACA,WAAOI,MAAP;AACD;;AAEY,QAAPoB,OAAO,CAACzB,IAAD,EAAOC,gBAAgB,GAAG,EAA1B,EAA8B;AAAA;;AACzC;AACA,UAAM;AAAE2B,MAAAA;AAAF,QAAY5B,IAAlB;;AACA,QAAI,gBAAA4B,KAAK,CAACiB,IAAN,kFAAYF,MAAZ,0EAAoB1B,MAApB,IAA6B,CAAjC,EAAoC;AAClC;AACA;AACA7C,MAAAA,QAAQ,CAAC4F,IAAT,CACG,sGADH,EAHkC,CAMlC;AACA;AACA;AACA;AACD;;AACD,UAAM;AAAE7B,MAAAA,OAAF;AAAWJ,MAAAA;AAAX,QAAuB,MAAM,KAAKC,MAAL,CAAY,EAC7C,GAAGhC,IAD0C;AAE7C4B,MAAAA,KAAK,EAAE,EAAE,GAAGA,KAAL;AAAYF,QAAAA,IAAI,EAAE,CAAlB;AAAqBC,QAAAA,KAAK,EAAE,CAA5B;AAA+BkB,QAAAA,IAAI,EAAEoB;AAArC;AAFsC,KAAZ,CAAnC;AAIA,UAAM5D,MAAM,GAAGQ,KAAK,CAACiB,IAAN,CAAWC,OAAX,CAAf;AACA,UAAMmC,KAAK,eAAG7D,MAAM,CAAC,CAAD,CAAT,+CAAgB,IAA3B;;AAEA,QAAI,CAAC6D,KAAL,EAAY;AACV;AACA;AACA;AACA;AACA;AACA;AACAjE,MAAAA,gBAAgB,CAACoB,cAAjB,GAAkCc,OAAO,CAACb,IAA1C;AACD;;AACD,WAAO,KAAKb,qBAAL,CAA2ByD,KAA3B,EAAkCjE,gBAAlC,CAAP;AACD;;AAEDsD,EAAAA,YAAY,CAACpD,IAAD,EAAOgE,WAAP,EAAoBhB,eAApB,EAAqC;AAC/C,UAAM1D,QAAQ,GAAGU,IAAI,CAACmB,IAAtB;;AACA,QAAI,CAAC,KAAKvC,mBAAL,CAAyBU,QAAzB,CAAL,EAAyC;AACvC,WAAKV,mBAAL,CAAyBU,QAAzB,IAAqC,EAArC;AACD;;AAED,SAAKV,mBAAL,CAAyBU,QAAzB,EAAmC2E,IAAnC,CAAwC;AACtCD,MAAAA,WADsC;AAEtChB,MAAAA;AAFsC,KAAxC;;AAKA,QAAI,CAAC,KAAKnE,qBAAL,CAA2BS,QAA3B,CAAL,EAA2C;AACzC,WAAKT,qBAAL,CAA2BS,QAA3B,IAAuC,IAAI4E,OAAJ,CAAYC,OAAO,IAAI;AAC5DC,QAAAA,OAAO,CAACC,QAAR,CAAiB,YAAY;AAC3B,gBAAM,KAAKC,2BAAL,CAAiCtE,IAAjC,CAAN;AACAmE,UAAAA,OAAO;AACR,SAHD;AAID,OALsC,CAAvC;AAMD;;AAED,WAAO,KAAKtF,qBAAL,CAA2BS,QAA3B,CAAP;AACD;;AAEgC,QAA3BgF,2BAA2B,CAACtE,IAAD,EAAO;AACtC,UAAMV,QAAQ,GAAGU,IAAI,CAACmB,IAAtB;AACA,UAAMoD,KAAK,GAAG,KAAK3F,mBAAL,CAAyBU,QAAzB,CAAd;AACA,SAAKV,mBAAL,CAAyBU,QAAzB,IAAqC,EAArC;AACA,SAAKT,qBAAL,CAA2BS,QAA3B,IAAuC,IAAvC;AAEA,UAAM;AAAE0E,MAAAA,WAAF;AAAehB,MAAAA;AAAf,QAAmCuB,KAAK,CAACC,MAAN,CACvC,CACE;AAAER,MAAAA,WAAF;AAAehB,MAAAA;AAAf,KADF,EAEE;AAAEgB,MAAAA,WAAW,EAAES,eAAf;AAAgCzB,MAAAA,eAAe,EAAE0B;AAAjD,KAFF,KAGK;AACH,aAAO;AACLV,QAAAA,WAAW,EAAEzG,CAAC,CAACoH,KAAF,CAAQX,WAAR,EAAqBS,eAArB,CADR;AAELzB,QAAAA,eAAe,EAAEzF,CAAC,CAACoH,KAAF,CAAQ3B,eAAR,EAAyB0B,mBAAzB;AAFZ,OAAP;AAID,KATsC,EAUvC;AACEV,MAAAA,WAAW,EAAE,EADf;AAEEhB,MAAAA,eAAe,EAAE;AAFnB,KAVuC,CAAzC;AAgBA,UAAM4B,qBAAqB,GAAGC,oBAAoB,CAChD7B,eADgD,EAEhD,KAAKlE,mBAAL,CAAyBgG,GAAzB,CAA6BxF,QAA7B,KAA0C,EAFM,CAAlD;;AAKA,QAAI,CAAC/B,CAAC,CAACwH,OAAF,CAAUH,qBAAV,CAAL,EAAuC;AACrC,YAAMI,aAAa,GAAG,IAAIjG,GAAJ,EAAtB;;AACA,WAAK,MAAMkB,IAAX,IAAmB,+BAAegF,kBAAf,CAAkC3F,QAAlC,CAAnB,EAAgE;AAC9D,aAAKe,4BAAL,CAAkCJ,IAAlC;AACA,cAAM0D,cAAc,GAAG,MAAMuB,gBAAgB,CAC3C,IAD2C,EAE3C,KAAK7G,cAFsC,EAG3C,KAAKD,MAHsC,EAI3C6B,IAJ2C,EAK3CD,IAL2C,EAM3CgE,WAN2C,EAO3CY,qBAP2C,CAA7C;;AASA,YAAI,CAAC3E,IAAI,CAACkF,iBAAV,EAA6B;AAC3BlF,UAAAA,IAAI,CAACkF,iBAAL,GAAyB,EAAzB;AACD;;AACDH,QAAAA,aAAa,CAACI,GAAd,CACEnF,IAAI,CAACF,EADP,EAEExC,CAAC,CAACoH,KAAF,CAAQ1E,IAAI,CAACkF,iBAAb,EAAgCxB,cAAhC,CAFF;AAID;;AACD,UAAIqB,aAAa,CAACK,IAAlB,EAAwB;AACtB,cAAMC,iBAAiB,CAAChG,QAAD,EAAW0F,aAAX,CAAvB;AACD;;AACD,WAAKlG,mBAAL,CAAyBsG,GAAzB,CACE9F,QADF,EAEE/B,CAAC,CAACoH,KAAF,CACE,EADF,EAEE,KAAK7F,mBAAL,CAAyBgG,GAAzB,CAA6BxF,QAA7B,KAA0C,EAF5C,EAGEsF,qBAHF,CAFF;AAQD;AACF;AAED;AACF;AACA;AACA;AACA;;;AACEW,EAAAA,QAAQ,GAAG;AACT,WAAO,0BAAP;AACD;AAED;AACF;AACA;AACA;AACA;;;AACElF,EAAAA,4BAA4B,CAACJ,IAAD,EAAO;AACjC,QAAI,CAAC,KAAKvB,iBAAL,CAAuB8G,GAAvB,CAA2BvF,IAA3B,CAAL,EAAuC;AACrCwF,MAAAA,yBAAyB,CACvB,KAAKjH,YADkB,EAEvByB,IAFuB,EAGvBA,IAAI,CAACF,EAHkB,EAIvB,IAJuB,EAKvB,IAAI2F,GAAJ,EALuB,CAAzB;;AAOA,WAAKhH,iBAAL,CAAuBiH,GAAvB,CAA2B1F,IAA3B;AACD;AACF;AAED;AACF;AACA;AACA;AACA;AACA;AACA;;;AACE2F,EAAAA,oBAAoB,CAACC,GAAD,EAAMC,SAAS,GAAG,IAAlB,EAAwB;AAC1C,QAAIC,UAAU,GAAG,CAAjB;AACA,QAAI9F,IAAI,GAAG4F,GAAX;;AAEA,WAAOE,UAAU,KAAK,GAAtB,EAA2B;AACzB,UAAID,SAAS,IAAIA,SAAS,CAAC7F,IAAD,CAA1B,EAAkC,OAAOA,IAAP;AAElC,YAAM+F,MAAM,GAAGpG,WAAW,CAACK,IAAI,CAAC+F,MAAN,CAA1B;;AACA,YAAMjG,EAAE,GAAG,KAAKvB,YAAL,CAAkBsG,GAAlB,CAAsB7E,IAAtB,CAAX;;AACA,YAAMgG,aAAa,GAAGrG,WAAW,CAACG,EAAD,CAAjC;;AAEA,UAAI,CAACiG,MAAD,IAAW,CAACC,aAAhB,EAA+B;AAC7B,cAAMC,cAAc,GAAG,CAACJ,SAAD,IAAcA,SAAS,CAAC7F,IAAD,CAA9C;AACA,eAAOiG,cAAc,GAAGjG,IAAH,GAAU,IAA/B;AACD;;AAEDA,MAAAA,IAAI,GAAG+F,MAAM,IAAIC,aAAjB;AACD;;AAEDhI,IAAAA,QAAQ,CAACkI,KAAT,CACG,oEAAD,GACElG,IAFJ;AAIA,WAAO,IAAP;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACEK,EAAAA,qBAAqB,CAACJ,MAAD,EAASJ,gBAAgB,GAAG,EAA5B,EAAgC;AACnD,UAAM;AAAEsG,MAAAA,IAAF;AAAQlF,MAAAA,cAAR;AAAwBmF,MAAAA,KAAK,GAAG;AAAhC,QAAyCvG,gBAA/C;;AACA,QAAIsG,IAAI,IAAIC,KAAZ,EAAmB;AACjB,UAAInF,cAAJ,EAAoB;AAClB,aAAK5C,oBAAL,CAA0B;AAAE8H,UAAAA,IAAF;AAAQlH,UAAAA,UAAU,EAAEgC;AAApB,SAA1B;AACD,OAFD,MAEO;AACL,cAAMT,KAAK,GAAG,0BAAWP,MAAX,IAAqBA,MAArB,GAA8B,CAACA,MAAD,CAA5C;;AACA,aAAK,MAAMD,IAAX,IAAmBQ,KAAnB,EAA0B;AACxB,cAAIR,IAAJ,EAAU;AACR,iBAAK3B,oBAAL,CAA0B;AAAE8H,cAAAA,IAAF;AAAQE,cAAAA,MAAM,EAAErG,IAAI,CAACF;AAArB,aAA1B;AACD;AACF;AACF;AACF;;AAED,WAAOG,MAAP;AACD;;AArdkB;;AAwdrB,MAAMP,mBAAN,CAA0B;AACxBxB,EAAAA,WAAW,CAACoI,aAAD,EAAgB7G,OAAhB,EAAyB;AAClC,SAAK8G,SAAL,GAAiBD,aAAjB;AACA,SAAK7G,OAAL,GAAeA,OAAf;AACD;;AAEDD,EAAAA,WAAW,CAACC,OAAD,EAAU;AACnB,WAAO,IAAIC,mBAAJ,CAAwB,KAAK6G,SAA7B,EAAwC,EAC7C,GAAG,KAAK9G,OADqC;AAE7C,SAAGA;AAF0C,KAAxC,CAAP;AAID;;AAED+G,EAAAA,oBAAoB,CAAC3G,gBAAD,EAAmB;AACrC,WAAO;AACLsG,MAAAA,IAAI,EAAE,KAAK1G,OAAL,CAAa0G,IADd;AAEL,UAAItG,gBAAgB,IAAI,EAAxB;AAFK,KAAP;AAID;;AAEDF,EAAAA,WAAW,CAACC,IAAD,EAAOC,gBAAP,EAAyB;AAClC,WAAO,KAAK0G,SAAL,CAAe5G,WAAf,CACLC,IADK,EAEL,KAAK4G,oBAAL,CAA0B3G,gBAA1B,CAFK,CAAP;AAID;;AAEDS,EAAAA,aAAa,CAACV,IAAD,EAAOC,gBAAP,EAAyB;AACpC,WAAO,KAAK0G,SAAL,CAAejG,aAAf,CACLV,IADK,EAEL,KAAK4G,oBAAL,CAA0B3G,gBAA1B,CAFK,CAAP;AAID;;AAEDiB,EAAAA,WAAW,CAAClB,IAAD,EAAOC,gBAAP,EAAyB;AAClC,WAAO,KAAK0G,SAAL,CAAezF,WAAf,CACLlB,IADK,EAEL,KAAK4G,oBAAL,CAA0B3G,gBAA1B,CAFK,CAAP;AAID;;AAEDsB,EAAAA,QAAQ,CAACvB,IAAD,EAAOC,gBAAP,EAAyB;AAC/B,WAAO,KAAK0G,SAAL,CAAepF,QAAf,CACLvB,IADK,EAEL,KAAK4G,oBAAL,CAA0B3G,gBAA1B,CAFK,CAAP;AAID;;AAEDwB,EAAAA,OAAO,CAACzB,IAAD,EAAOC,gBAAP,EAAyB;AAC9B,WAAO,KAAK0G,SAAL,CAAelF,OAAf,CACLzB,IADK,EAEL,KAAK4G,oBAAL,CAA0B3G,gBAA1B,CAFK,CAAP;AAID;;AAED4B,EAAAA,OAAO,CAAC7B,IAAD,EAAOC,gBAAP,EAAyB;AAC9B,WAAO,KAAK0G,SAAL,CAAe9E,OAAf,CACL7B,IADK,EAEL,KAAK4G,oBAAL,CAA0B3G,gBAA1B,CAFK,CAAP;AAID;;AAEDsD,EAAAA,YAAY,CAAC,GAAGvD,IAAJ,EAAU;AACpB,WAAO,KAAK2G,SAAL,CAAepD,YAAf,CAA4B,GAAGvD,IAA/B,CAAP;AACD;;AAED0F,EAAAA,QAAQ,CAAC,GAAG1F,IAAJ,EAAU;AAChB,WAAO,KAAK2G,SAAL,CAAejB,QAAf,CAAwB,GAAG1F,IAA3B,CAAP;AACD;;AAEDQ,EAAAA,4BAA4B,CAAC,GAAGR,IAAJ,EAAU;AACpC,WAAO,KAAK2G,SAAL,CAAenG,4BAAf,CAA4C,GAAGR,IAA/C,CAAP;AACD;;AAED+F,EAAAA,oBAAoB,CAAC,GAAG/F,IAAJ,EAAU;AAC5B,WAAO,KAAK2G,SAAL,CAAeZ,oBAAf,CAAoC,GAAG/F,IAAvC,CAAP;AACD;;AAEDvB,EAAAA,oBAAoB,CAAC,GAAGuB,IAAJ,EAAU;AAC5B,WAAO,KAAK2G,SAAL,CAAelI,oBAAf,CAAoC,GAAGuB,IAAvC,CAAP;AACD;;AAEDS,EAAAA,qBAAqB,CAACJ,MAAD,EAASJ,gBAAT,EAA2B;AAC9C,WAAO,KAAK0G,SAAL,CAAelG,qBAAf,CACLJ,MADK,EAEL,KAAKuG,oBAAL,CAA0B3G,gBAA1B,CAFK,CAAP;AAID;;AAvFuB;;AA0F1B,MAAMF,WAAW,GAAGG,EAAE,IAAKA,EAAE,IAAI,IAAN,GAAa,wBAAQA,EAAR,CAAb,GAA2B,IAAtD;;AAEA,MAAMX,eAAe,GAAG,CAAChB,MAAD,EAASsI,WAAT,KAAyB;AAC/C,QAAM1E,OAAO,GACX,OAAO0E,WAAP,KAAwB,QAAxB,GAAkCtI,MAAM,CAAC6D,OAAP,CAAeyE,WAAf,CAAlC,GAAgEA,WADlE;AAGA,MAAI,CAAC1E,OAAL,EAAc,OAAO,EAAP;AAEd,QAAM2E,aAAa,GAAGlJ,cAAc,CAACuE,OAAD,CAAd,GAClB5D,MAAM,CAACwI,gBAAP,CAAwB5E,OAAxB,CADkB,GAElB,CAACA,OAAD,CAFJ;AAIA,SAAO2E,aAAa,CACjB/F,MADI,CACGZ,IAAI,IAAIA,IAAI,CAAC6G,aAAL,GAAqBC,IAArB,CAA0BC,KAAK,IAAIA,KAAK,CAAC5F,IAAN,KAAgB,MAAnD,CADX,EAEJ5B,GAFI,CAEAS,IAAI,IAAIA,IAAI,CAACmB,IAFb,CAAP;AAGD,CAbD;;AAeA,MAAMsB,cAAc,GAAG,CAAC;AAAE7B,EAAAA,MAAF;AAAU8B,EAAAA,IAAV;AAAgBC,EAAAA,KAAhB;AAAuBC,EAAAA,QAAvB;AAAiCC,EAAAA,GAAjC;AAAsCC,EAAAA,GAAtC;AAA2CC,EAAAA;AAA3C,CAAD,KAAsD;AAC3E,QAAMiE,YAAY,GAAGpG,MAAM,GAAGqG,kBAAkB,CAACrG,MAAD,CAArB,GAAgC,EAA3D;AACA,QAAMsG,UAAU,GAAIxE,IAAI,IAAIA,IAAI,CAACF,MAAd,IAAyB,EAA5C;;AAEA,MAAIG,KAAK,IAAI,CAACjC,KAAK,CAACC,OAAN,CAAcgC,KAAd,CAAd,EAAoC;AAClCA,IAAAA,KAAK,GAAG,CAACA,KAAD,CAAR;AACD,GAFD,MAEO,IAAIA,KAAK,IAAI,IAAb,EAAmB;AACxBA,IAAAA,KAAK,GAAG,EAAR;AACD;;AAED,MAAIC,QAAQ,IAAI,CAAClC,KAAK,CAACC,OAAN,CAAciC,QAAd,CAAjB,EAA0C;AACxCA,IAAAA,QAAQ,GAAG,CAACA,QAAD,CAAX;AACD,GAFD,MAEO,IAAIA,QAAQ,IAAI,IAAhB,EAAsB;AAC3BA,IAAAA,QAAQ,GAAG,EAAX;AACD;;AAED,MAAIC,GAAG,IAAI,CAACnC,KAAK,CAACC,OAAN,CAAckC,GAAd,CAAZ,EAAgC;AAC9BA,IAAAA,GAAG,GAAG,CAACA,GAAD,CAAN;AACD,GAFD,MAEO,IAAIA,GAAG,IAAI,IAAX,EAAiB;AACtBA,IAAAA,GAAG,GAAG,EAAN;AACD;;AAED,MAAIC,GAAG,IAAI,CAACpC,KAAK,CAACC,OAAN,CAAcmC,GAAd,CAAZ,EAAgC;AAC9BA,IAAAA,GAAG,GAAG,CAACA,GAAD,CAAN;AACD,GAFD,MAEO,IAAIA,GAAG,IAAI,IAAX,EAAiB;AACtBA,IAAAA,GAAG,GAAG,EAAN;AACD;;AAED,MAAIC,GAAG,IAAI,CAACrC,KAAK,CAACC,OAAN,CAAcoC,GAAd,CAAZ,EAAgC;AAC9BA,IAAAA,GAAG,GAAG,CAACA,GAAD,CAAN;AACD,GAFD,MAEO,IAAIA,GAAG,IAAI,IAAX,EAAiB;AACtBA,IAAAA,GAAG,GAAG,EAAN;AACD;;AAED,SAAOxF,CAAC,CAACoH,KAAF,CACLqC,YADK,EAEL,GAAGE,UAAU,CAAC3H,GAAX,CAAe4H,YAAf,CAFE,EAGL,GAAGxE,KAAK,CAACpD,GAAN,CAAU4H,YAAV,CAHE,EAIL,GAAGvE,QAAQ,CAACrD,GAAT,CAAa4H,YAAb,CAJE,EAKL,GAAGtE,GAAG,CAACtD,GAAJ,CAAQ4H,YAAR,CALE,EAML,GAAGrE,GAAG,CAACvD,GAAJ,CAAQ4H,YAAR,CANE,EAOL,GAAGpE,GAAG,CAACxD,GAAJ,CAAQ4H,YAAR,CAPE,CAAP;AASD,CA3CD;;AA6CA,MAAMA,YAAY,GAAGf,IAAI,IAAI;AAC3B,MAAIA,IAAI,IAAI,OAAOA,IAAP,KAAiB,QAA7B,EAAsC;AACpC,WAAOA,IAAI,CAACgB,KAAL,CAAY,GAAZ,EAAgBC,WAAhB,CAA4B,CAACC,GAAD,EAAMC,GAAN,KAAc;AAC/C,aAAO;AAAE,SAACA,GAAD,GAAOD;AAAT,OAAP;AACD,KAFM,EAEJ,IAFI,CAAP;AAGD;;AACD,SAAO,EAAP;AACD,CAPD;;AASA,MAAML,kBAAkB,GAAGrG,MAAM,IAC/B4G,MAAM,CAACC,IAAP,CAAY7G,MAAZ,EAAoB4D,MAApB,CAA2B,CAAC8C,GAAD,EAAMC,GAAN,KAAc;AACvC,QAAMG,KAAK,GAAG9G,MAAM,CAAC2G,GAAD,CAApB;AACA,QAAMI,CAAC,GAAGH,MAAM,CAACC,IAAP,CAAYC,KAAZ,EAAmB,CAAnB,CAAV;AACA,QAAME,CAAC,GAAGF,KAAK,CAACC,CAAD,CAAf;;AACA,MAAIpK,CAAC,CAACsK,aAAF,CAAgBH,KAAhB,KAA0BnK,CAAC,CAACsK,aAAF,CAAgBD,CAAhB,CAA9B,EAAkD;AAChDN,IAAAA,GAAG,CAACC,GAAD,CAAH,GACEI,CAAC,KAAM,WAAP,GAAoBV,kBAAkB,CAACW,CAAD,CAAtC,GAA4CX,kBAAkB,CAACS,KAAD,CADhE;AAED,GAHD,MAGO;AACLJ,IAAAA,GAAG,CAACC,GAAD,CAAH,GAAW,IAAX;AACD;;AACD,SAAOD,GAAP;AACD,CAXD,EAWG,EAXH,CADF;;AAcA,MAAMQ,SAAS,GAAG,CAAC1J,MAAD,EAAS4B,IAAT,EAAeC,IAAf,KAAwB;AACxC,MAAI,CAACxC,cAAc,CAACuC,IAAD,CAAnB,EAA2B;AACzB,WAAOA,IAAI,CAAC8H,SAAL,EAAP;AACD;;AAED,QAAMC,YAAY,GAAG/H,IAAI,CAACgI,WAAL,CAAiB/H,IAAjB,CAArB;AACA,SAAO7B,MAAM,CAAC6D,OAAP,CAAe8F,YAAf,EAA6BD,SAA7B,EAAP;AACD,CAPD;;AASA,eAAe5C,gBAAf,CACEsB,SADF,EAEEnI,cAFF,EAGED,MAHF,EAIE6B,IAJF,EAKED,IALF,EAMEgE,WANF,EAOEhB,eAPF,EAQE;AACA,QAAMiF,SAAS,GAAGH,SAAS,CAAC1J,MAAD,EAAS4B,IAAT,EAAeC,IAAf,CAA3B;AACA,QAAM0D,cAAc,GAAG,EAAvB;;AACA,OAAK,MAAMuE,SAAX,IAAwBV,MAAM,CAACC,IAAP,CAAYzE,eAAZ,CAAxB,EAAsD;AACpD,UAAMmF,cAAc,GAAGnF,eAAe,CAACkF,SAAD,CAAtC;AACA,UAAME,UAAU,GAAGpE,WAAW,CAACkE,SAAD,CAA9B;AACA,UAAMG,QAAQ,GAAGJ,SAAS,CAACC,SAAD,CAA1B;AACA,UAAMI,cAAc,GAAGxK,eAAe,CAACuK,QAAQ,CAACrI,IAAV,CAAtC;AACA,UAAMuI,YAAY,GAAG1K,YAAY,CAACwK,QAAQ,CAACrI,IAAV,CAAjC;AACA,QAAIwI,UAAU,GAAG,MAAMC,YAAY,CACjCjC,SADiC,EAEjCnI,cAFiC,EAGjCD,MAHiC,EAIjC6B,IAJiC,EAKjCoI,QALiC,EAMjCH,SANiC,CAAnC;;AAQA,QAAIG,QAAQ,IAAIG,UAAU,IAAI,IAA9B,EAAoC;AAClC,UACEzK,eAAe,CAACwK,YAAD,CAAf,IACA,EAAED,cAAc,YAAY1K,WAA5B,CAFF,EAGE;AACA4K,QAAAA,UAAU,GAAG,MAAMtD,gBAAgB,CACjCsB,SADiC,EAEjCnI,cAFiC,EAGjCD,MAHiC,EAIjCoK,UAJiC,EAKjCD,YALiC,EAMjCH,UANiC,EAOjC7K,CAAC,CAACmL,QAAF,CAAWP,cAAX,IAA6BA,cAA7B,GAA8CC,UAPb,CAAnC;AASD,OAbD,MAaO,IACLrK,eAAe,CAACwK,YAAD,CAAf,IACAhL,CAAC,CAACoD,OAAF,CAAU6H,UAAV,CADA,IAEAF,cAAc,YAAY1K,WAHrB,EAIL;AACA4K,QAAAA,UAAU,GAAG,MAAMtE,OAAO,CAACyE,GAAR,CACjBH,UAAU,CAACjJ,GAAX,CAAeqJ,IAAI,IACjBA,IAAI,IAAI,IAAR,GACIA,IADJ,GAEI1D,gBAAgB,CACdsB,SADc,EAEdnI,cAFc,EAGdD,MAHc,EAIdwK,IAJc,EAKdL,YALc,EAMdH,UANc,EAOd7K,CAAC,CAACmL,QAAF,CAAWP,cAAX,IAA6BA,cAA7B,GAA8CC,UAPhC,CAHtB,CADiB,CAAnB;AAeD;AACF;;AACD,QAAII,UAAU,IAAI,IAAlB,EAAwB;AACtB7E,MAAAA,cAAc,CAACuE,SAAD,CAAd,GAA4BM,UAA5B;AACD;AACF;;AAED,OAAK,MAAMN,SAAX,IAAwBV,MAAM,CAACC,IAAP,CAAYzD,WAAZ,CAAxB,EAAkD;AAChD,QAAI,CAAChB,eAAe,CAACkF,SAAD,CAAhB,IAA+BjI,IAAI,CAACiI,SAAD,CAAvC,EAAoD;AAClD;AACA;AACAvE,MAAAA,cAAc,CAACuE,SAAD,CAAd,GAA4B,MAAMO,YAAY,CAC5CjC,SAD4C,EAE5CnI,cAF4C,EAG5CD,MAH4C,EAI5C6B,IAJ4C,EAK5CgI,SAAS,CAACC,SAAD,CALmC,EAM5CA,SAN4C,CAA9C;AAQD;AACF;;AAED,SAAO3K,CAAC,CAACsL,MAAF,CAASlF,cAAT,EAAyB,CAAC+D,KAAD,EAAQH,GAAR,KAAgBvD,WAAW,CAACuD,GAAD,CAApD,CAAP;AACD;;AAED,SAASkB,YAAT,CACEjC,SADF,EAEEnI,cAFF,EAGED,MAHF,EAIE6B,IAJF,EAKEoI,QALF,EAMEH,SANF,EAOE;AACA,MAAI,EAACG,QAAD,aAACA,QAAD,eAACA,QAAQ,CAAElE,OAAX,CAAJ,EAAwB;AACtB,WAAOlE,IAAI,CAACiI,SAAD,CAAX;AACD;;AACD,QAAMY,mBAAmB,GAAGtL,OAAO,CAAE,WAAF,CAAnC;;AACA,SAAO6K,QAAQ,CAAClE,OAAT,CACLlE,IADK,EAELoI,QAAQ,CAACxI,IAAT,CAAc2E,MAAd,CAAqB,CAAC8C,GAAD,EAAMyB,GAAN,KAAc;AACjCzB,IAAAA,GAAG,CAACyB,GAAG,CAAC5H,IAAL,CAAH,GAAgB4H,GAAG,CAACC,YAApB;AACA,WAAO1B,GAAP;AACD,GAHD,EAGG,EAHH,CAFK,EAMLwB,mBAAmB,CAAC;AAClB1K,IAAAA,MADkB;AAElBC,IAAAA,cAFkB;AAGlBmI,IAAAA;AAHkB,GAAD,CANd,EAWL;AACE0B,IAAAA,SADF;AAEE9J,IAAAA,MAFF;AAGE6K,IAAAA,UAAU,EAAEZ,QAAQ,CAACrI;AAHvB,GAXK,CAAP;AAiBD;;AAED,MAAMiD,yBAAyB,GAAG,CAChC5E,cADgC,EAEhCD,MAFgC,EAGhC4B,IAHgC,EAIhCwC,MAJgC,EAKhCrD,aALgC,EAMhC+J,YAAY,GAAG,KANiB,KAO7B;AACH,QAAMlG,eAAe,GAAG,EAAxB;AACA,QAAMiF,SAAS,GAAGjI,IAAI,CAAC8H,SAAL,EAAlB;AACAN,EAAAA,MAAM,CAACC,IAAP,CAAYjF,MAAZ,EAAoBnD,OAApB,CAA4B6I,SAAS,IAAI;AACvC,UAAMiB,KAAK,GAAG3G,MAAM,CAAC0F,SAAD,CAApB;AACA,UAAMG,QAAQ,GAAGJ,SAAS,CAACC,SAAD,CAA1B;AACA,UAAMK,YAAY,GAAG1K,YAAY,CAACwK,QAAQ,CAACrI,IAAV,CAAjC;AACA,UAAMoJ,YAAY,GAAG/K,cAAc,CAACgL,QAAf,CAAwBrJ,IAAI,CAACmB,IAA7B,CAArB;AACA,UAAMmI,WAAW,GAAG,CAClBF,YADkB,EAElB,GAAGjK,aAAa,CAACI,GAAd,CAAkB4B,IAAI,IAAI9C,cAAc,CAACgL,QAAf,CAAwBlI,IAAxB,CAA1B,CAFe,CAApB;AAIA,QAAIoI,YAAY,GAAG,KAAnB;;AACA,SAAK,MAAMC,EAAX,IAAiBF,WAAjB,EAA8B;AAC5BC,MAAAA,YAAY,GAAGC,EAAE,CAACC,iBAAH,CAAqBvB,SAArB,EAAiC,cAAjC,KAAmD,KAAlE;;AACA,UAAIqB,YAAJ,EAAkB;AAChB;AACD;AACF;;AAED,QAAIhM,CAAC,CAACmL,QAAF,CAAWS,KAAX,KAAqBd,QAAzB,EAAmC;AACjC,YAAMqB,aAAa,GAAGzG,yBAAyB,CAC7C5E,cAD6C,EAE7CD,MAF6C,EAG7CmK,YAH6C,EAI7CY,KAJ6C,EAK7C/J,eAAe,CAAChB,MAAD,EAASmK,YAAT,CAL8B,EAM7C,IAN6C,CAA/C;;AAQA,UAAI,CAAChL,CAAC,CAACwH,OAAF,CAAU2E,aAAV,CAAL,EAA+B;AAC7B1G,QAAAA,eAAe,CAACkF,SAAD,CAAf,GAA6BwB,aAA7B;AACD;AACF;;AAED,QAAI,CAAC1G,eAAe,CAACkF,SAAD,CAAhB,IAA+BqB,YAAnC,EAAiD;AAC/CvG,MAAAA,eAAe,CAACkF,SAAD,CAAf,GAA6B,IAA7B;AACD;;AACD,QAAI,CAAClF,eAAe,CAACkF,SAAD,CAAhB,IAA+BgB,YAAnC,EAAiD;AAC/C;AACA;AACAlG,MAAAA,eAAe,CAACkF,SAAD,CAAf,GAA6B,IAA7B;AACD;AACF,GAvCD;AAwCA,SAAOlF,eAAP;AACD,CAnDD;;AAqDA,MAAMyC,yBAAyB,GAAG,CAChCkE,WADgC,EAEhCC,IAFgC,EAGhCtD,MAHgC,EAIhCuD;AAAO;AAJyB,EAKhCzD;AAAK;AAL2B,KAMhB;AAChB,QAAMyB,aAAa,GAAGtK,CAAC,CAACsK,aAAF,CAAgB+B,IAAhB,CAAtB;;AAEA,MAAI/B,aAAa,IAAItK,CAAC,CAACoD,OAAF,CAAUiJ,IAAV,CAArB,EAAsC;AACpC,QAAIxD,IAAI,CAACZ,GAAL,CAASoE,IAAT,CAAJ,EAAoB;AACpBxD,IAAAA,IAAI,CAACT,GAAL,CAASiE,IAAT;;AAEArM,IAAAA,CAAC,CAACuM,IAAF,CAAOF,IAAP,EAAa,CAACG,CAAD,EAAIxC,GAAJ,KAAY;AACvB,UAAI,CAACsC,MAAD,IAAWtC,GAAG,KAAM,UAAxB,EAAmC;AACjC9B,QAAAA,yBAAyB,CAACkE,WAAD,EAAcI,CAAd,EAAiBzD,MAAjB,EAAyB,KAAzB,EAAgCF,IAAhC,CAAzB;AACD;AACF,KAJD,EAJoC,CAUpC;;;AACA,QAAI,CAACyD,MAAL,EAAa;AACXF,MAAAA,WAAW,CAACvE,GAAZ,CAAgBwE,IAAhB,EAAsBtD,MAAtB;AACD;AACF;AACF,CAxBD;;AA0BA,MAAMhB,iBAAiB,GAAG,OAAOhG,QAAP,EAAiB0F,aAAjB,KAAmC;AAC3DgF,eAAMC,QAAN,CAAe;AACbjK,IAAAA,IAAI,EAAG,oBADM;AAEbkK,IAAAA,OAAO,EAAE;AACP3C,MAAAA,GAAG,EAAEjI,QADE;AAEPmB,MAAAA,KAAK,EAAEuE;AAFA;AAFI,GAAf;AAOD,CARD;;AAUA,MAAMH,oBAAoB,GAAG,CAAClD,IAAD,EAAOwI,EAAP,KAAc;AACzC,QAAMjK,MAAM,GAAG,EAAf;AACAsH,EAAAA,MAAM,CAACC,IAAP,CAAY9F,IAAZ,EAAkBtC,OAAlB,CAA0BkI,GAAG,IAAI;AAC/B,UAAM6C,OAAO,GAAGD,EAAE,CAAC5C,GAAD,CAAlB;;AACA,QAAI6C,OAAJ,EAAa;AACX,UAAI7M,CAAC,CAACsK,aAAF,CAAgBuC,OAAhB,CAAJ,EAA8B;AAC5B,cAAMC,UAAU,GAAGxF,oBAAoB,CAAClD,IAAI,CAAC4F,GAAD,CAAL,EAAY6C,OAAZ,CAAvC;;AACA,YAAI,CAAC7M,CAAC,CAACwH,OAAF,CAAUsF,UAAV,CAAL,EAA4B;AAC1BnK,UAAAA,MAAM,CAACqH,GAAD,CAAN,GAAc8C,UAAd;AACD;AACF;AACF,KAPD,MAOO;AACLnK,MAAAA,MAAM,CAACqH,GAAD,CAAN,GAAc5F,IAAI,CAAC4F,GAAD,CAAlB;AACD;AACF,GAZD;AAaA,SAAOrH,MAAP;AACD,CAhBD;;AAkBAoK,MAAM,CAACC,OAAP,GAAiB;AACfrM,EAAAA;AADe,CAAjB","sourcesContent":["// @flow\n\nconst _ = require(`lodash`)\nconst {\n  isAbstractType,\n  GraphQLOutputType,\n  GraphQLUnionType,\n  GraphQLList,\n  getNamedType,\n  getNullableType,\n  isCompositeType,\n} = require(`graphql`)\nconst invariant = require(`invariant`)\nconst reporter = require(`gatsby-cli/lib/reporter`)\nimport { store } from \"../redux\"\nimport {\n  getDataStore,\n  getNode,\n  getNodes,\n  getNodesByType,\n  getTypes,\n} from \"../datastore\"\nimport { isIterable } from \"../datastore/common/iterable\"\n\ntype TypeOrTypeName = string | GraphQLOutputType\n\n/**\n * Optional page dependency information.\n *\n * @typedef {Object} PageDependencies\n * @property {string} path The path of the page that depends on the retrieved nodes' data\n * @property {string} [connectionType] Mark this dependency as a connection\n */\ninterface PageDependencies {\n  path: string;\n  connectionType?: string;\n}\n\ninterface QueryArguments {\n  type: TypeOrTypeName;\n  query: { filter: Object, sort?: Object };\n  firstOnly?: boolean;\n}\n\nexport interface NodeModel {\n  getNodeById(\n    { id: string, type?: TypeOrTypeName },\n    pageDependencies?: PageDependencies\n  ): any | null;\n  getNodesByIds(\n    { ids: Array<string>, type?: TypeOrTypeName },\n    pageDependencies?: PageDependencies\n  ): Array<any>;\n  getAllNodes(\n    { type?: TypeOrTypeName },\n    pageDependencies?: PageDependencies\n  ): Array<any>;\n  runQuery(\n    args: QueryArguments,\n    pageDependencies?: PageDependencies\n  ): Promise<any>;\n  getTypes(): Array<string>;\n  trackPageDependencies<nodeOrNodes: Node | Node[]>(\n    result: nodeOrNodes,\n    pageDependencies?: PageDependencies\n  ): nodesOrNodes;\n  findRootNodeAncestor(obj: any, predicate: () => boolean): Node | null;\n  trackInlineObjectsInRootNode(node: Node, sanitize: boolean): Node;\n}\n\nclass LocalNodeModel {\n  constructor({ schema, schemaComposer, createPageDependency }) {\n    this.schema = schema\n    this.schemaComposer = schemaComposer\n    this.createPageDependencyActionCreator = createPageDependency\n\n    this._rootNodeMap = new WeakMap()\n    this._trackedRootNodes = new WeakSet()\n    this._prepareNodesQueues = {}\n    this._prepareNodesPromises = {}\n    this._preparedNodesCache = new Map()\n    this.replaceFiltersCache()\n  }\n\n  createPageDependency(createPageDependencyArgs) {\n    if (createPageDependencyArgs.connection) {\n      const nodeTypeNames = toNodeTypeNames(\n        this.schema,\n        createPageDependencyArgs.connection\n      )\n      if (nodeTypeNames) {\n        nodeTypeNames.forEach(typeName => {\n          this.createPageDependencyActionCreator({\n            ...createPageDependencyArgs,\n            connection: typeName,\n          })\n        })\n        return\n      }\n    }\n\n    this.createPageDependencyActionCreator(createPageDependencyArgs)\n  }\n\n  /**\n   * Replace the cache either with the value passed on (mainly for tests) or\n   * an empty new Map.\n   *\n   * @param {undefined | null | FiltersCache} map\n   *   (This cached is used in redux/nodes.js and caches a set of buckets (Sets)\n   *   of Nodes based on filter and tracks this for each set of types which are\n   *   actually queried. If the filter targets `id` directly, only one Node is\n   *   cached instead of a Set of Nodes. If null, don't create or use a cache.\n   */\n  replaceFiltersCache(map = new Map()) {\n    this._filtersCache = map // See redux/nodes.js for usage\n  }\n\n  withContext(context) {\n    return new ContextualNodeModel(this, context)\n  }\n\n  /**\n   * Get a node from the store by ID and optional type.\n   *\n   * @param {Object} args\n   * @param {string} args.id ID of the requested node\n   * @param {(string|GraphQLOutputType)} [args.type] Optional type of the node\n   * @param {PageDependencies} [pageDependencies]\n   * @returns {(Node|null)}\n   */\n  getNodeById(args, pageDependencies) {\n    const { id, type } = args || {}\n\n    const node = getNodeById(id)\n\n    let result\n    if (!node) {\n      result = null\n    } else if (!type) {\n      result = node\n    } else {\n      const nodeTypeNames = toNodeTypeNames(this.schema, type)\n      result = nodeTypeNames.includes(node.internal.type) ? node : null\n    }\n\n    if (result) {\n      this.trackInlineObjectsInRootNode(node)\n    }\n\n    return this.trackPageDependencies(result, pageDependencies)\n  }\n\n  /**\n   * Get nodes from the store by IDs and optional type.\n   *\n   * @param {Object} args\n   * @param {string[]} args.ids IDs of the requested nodes\n   * @param {(string|GraphQLOutputType)} [args.type] Optional type of the nodes\n   * @param {PageDependencies} [pageDependencies]\n   * @returns {Node[]}\n   */\n  getNodesByIds(args, pageDependencies) {\n    const { ids, type } = args || {}\n\n    const nodes = Array.isArray(ids)\n      ? ids.map(id => getNodeById(id)).filter(Boolean)\n      : []\n\n    let result\n    if (!nodes.length || !type) {\n      result = nodes\n    } else {\n      const nodeTypeNames = toNodeTypeNames(this.schema, type)\n      result = nodes.filter(node => nodeTypeNames.includes(node.internal.type))\n    }\n\n    if (result) {\n      result.forEach(node => this.trackInlineObjectsInRootNode(node))\n    }\n\n    return this.trackPageDependencies(result, pageDependencies)\n  }\n\n  /**\n   * Get all nodes in the store, or all nodes of a specified type. Note that\n   * this adds connectionType tracking by default if type is passed.\n   *\n   * @param {Object} args\n   * @param {(string|GraphQLOutputType)} [args.type] Optional type of the nodes\n   * @param {PageDependencies} [pageDependencies]\n   * @returns {Node[]}\n   */\n  getAllNodes(args, pageDependencies = {}) {\n    // TODO: deprecate this method in favor of runQuery\n    const { type = `Node` } = args || {}\n\n    let result\n    if (type === `Node`) {\n      result = getNodes()\n    } else {\n      const nodeTypeNames = toNodeTypeNames(this.schema, type)\n      const nodesByType = nodeTypeNames.map(typeName =>\n        getNodesByType(typeName)\n      )\n      const nodes = [].concat(...nodesByType)\n      result = nodes.filter(Boolean)\n    }\n\n    if (result) {\n      result.forEach(node => this.trackInlineObjectsInRootNode(node))\n    }\n\n    if (typeof pageDependencies.connectionType === `undefined`) {\n      pageDependencies.connectionType =\n        typeof type === `string` ? type : type.name\n    }\n\n    return this.trackPageDependencies(result, pageDependencies)\n  }\n\n  /**\n   * Get nodes of a type matching the specified query.\n   *\n   * @param {Object} args\n   * @param {Object} args.query Query arguments (`filter` and `sort`)\n   * @param {(string|GraphQLOutputType)} args.type Type\n   * @param {boolean} [args.firstOnly] If true, return only first match\n   * @param {PageDependencies} [pageDependencies]\n   * @returns {Promise<Node[]>}\n   */\n  async runQuery(args, pageDependencies = {}) {\n    // TODO: show deprecation warning in v4\n    // reporter.warn(\n    //   `nodeModel.runQuery() is deprecated. Use nodeModel.findAll() or nodeModel.findOne() instead`\n    // )\n    if (args.firstOnly) {\n      return this.findOne(args, pageDependencies)\n    }\n    const { skip, limit, ...query } = args.query\n    const result = await this.findAll({ ...args, query }, pageDependencies)\n    return Array.from(result.entries)\n  }\n\n  async _query(args) {\n    const { query, type, stats, tracer } = args || {}\n\n    // We don't support querying union types (yet?), because the combined types\n    // need not have any fields in common.\n    const gqlType = typeof type === `string` ? this.schema.getType(type) : type\n    invariant(\n      !(gqlType instanceof GraphQLUnionType),\n      `Querying GraphQLUnion types is not supported.`\n    )\n\n    const nodeTypeNames = toNodeTypeNames(this.schema, gqlType)\n\n    let materializationActivity\n    if (tracer) {\n      materializationActivity = reporter.phantomActivity(`Materialization`, {\n        parentSpan: tracer.getParentActivity().span,\n      })\n      materializationActivity.start()\n    }\n    const fields = getQueryFields({\n      filter: query.filter,\n      sort: query.sort,\n      group: query.group,\n      distinct: query.distinct,\n      max: query.max,\n      min: query.min,\n      sum: query.sum,\n    })\n    const fieldsToResolve = determineResolvableFields(\n      this.schemaComposer,\n      this.schema,\n      gqlType,\n      fields,\n      nodeTypeNames\n    )\n\n    for (const nodeTypeName of nodeTypeNames) {\n      const gqlNodeType = this.schema.getType(nodeTypeName)\n      await this.prepareNodes(gqlNodeType, fields, fieldsToResolve)\n    }\n\n    if (materializationActivity) {\n      materializationActivity.end()\n    }\n\n    let runQueryActivity\n    if (tracer) {\n      runQueryActivity = reporter.phantomActivity(`runQuery`, {\n        parentSpan: tracer.getParentActivity().span,\n      })\n      runQueryActivity.start()\n    }\n\n    const { entries, totalCount } = await getDataStore().runQuery({\n      queryArgs: query,\n      gqlSchema: this.schema,\n      gqlComposer: this.schemaComposer,\n      gqlType,\n      resolvedFields: fieldsToResolve,\n      nodeTypeNames,\n      filtersCache: this._filtersCache,\n      stats,\n    })\n\n    if (runQueryActivity) {\n      runQueryActivity.end()\n    }\n\n    return {\n      gqlType,\n      entries: entries.map(node => {\n        // With GatsbyIterable it happens lazily as we iterate\n        this.trackInlineObjectsInRootNode(node)\n        return node\n      }),\n      totalCount,\n    }\n  }\n\n  async findAll(args, pageDependencies = {}) {\n    // TODO: add this as a public API in v4 (together with deprecating runQuery)\n    const { gqlType, ...result } = await this._query(args, pageDependencies)\n\n    // Tracking connections by default:\n    if (typeof pageDependencies.connectionType === `undefined`) {\n      pageDependencies.connectionType = gqlType.name\n    }\n    this.trackPageDependencies(result.entries, pageDependencies)\n    return result\n  }\n\n  async findOne(args, pageDependencies = {}) {\n    // TODO: add this as a public API in v4 (together with deprecating runQuery)\n    const { query } = args\n    if (query.sort?.fields?.length > 0) {\n      // If we support sorting and return the first node based on sorting\n      // we'll have to always track connection not an individual node\n      reporter.warn(\n        `nodeModel.findOne() does not support sorting. Use nodeModel.findAll({ query: { limit: 1 } }) instead`\n      )\n      // TODO: throw in v4\n      // throw new Error(\n      //   `nodeModel.findOne() does not support sorting. Use nodeModel.findAll({ query: { limit: 1 } }) instead`\n      // )\n    }\n    const { gqlType, entries } = await this._query({\n      ...args,\n      query: { ...query, skip: 0, limit: 1, sort: undefined },\n    })\n    const result = Array.from(entries)\n    const first = result[0] ?? null\n\n    if (!first) {\n      // Couldn't find matching node.\n      //  This leads to a state where data tracking for this query gets empty.\n      //  It means we will NEVER re-run this query on any data updates\n      //  (even if a new node matching this query is added at some point).\n      //  To workaround this, we have to add a connection tracking to re-run\n      //  the query whenever any node of this type changes.\n      pageDependencies.connectionType = gqlType.name\n    }\n    return this.trackPageDependencies(first, pageDependencies)\n  }\n\n  prepareNodes(type, queryFields, fieldsToResolve) {\n    const typeName = type.name\n    if (!this._prepareNodesQueues[typeName]) {\n      this._prepareNodesQueues[typeName] = []\n    }\n\n    this._prepareNodesQueues[typeName].push({\n      queryFields,\n      fieldsToResolve,\n    })\n\n    if (!this._prepareNodesPromises[typeName]) {\n      this._prepareNodesPromises[typeName] = new Promise(resolve => {\n        process.nextTick(async () => {\n          await this._doResolvePrepareNodesQueue(type)\n          resolve()\n        })\n      })\n    }\n\n    return this._prepareNodesPromises[typeName]\n  }\n\n  async _doResolvePrepareNodesQueue(type) {\n    const typeName = type.name\n    const queue = this._prepareNodesQueues[typeName]\n    this._prepareNodesQueues[typeName] = []\n    this._prepareNodesPromises[typeName] = null\n\n    const { queryFields, fieldsToResolve } = queue.reduce(\n      (\n        { queryFields, fieldsToResolve },\n        { queryFields: nextQueryFields, fieldsToResolve: nextFieldsToResolve }\n      ) => {\n        return {\n          queryFields: _.merge(queryFields, nextQueryFields),\n          fieldsToResolve: _.merge(fieldsToResolve, nextFieldsToResolve),\n        }\n      },\n      {\n        queryFields: {},\n        fieldsToResolve: {},\n      }\n    )\n\n    const actualFieldsToResolve = deepObjectDifference(\n      fieldsToResolve,\n      this._preparedNodesCache.get(typeName) || {}\n    )\n\n    if (!_.isEmpty(actualFieldsToResolve)) {\n      const resolvedNodes = new Map()\n      for (const node of getDataStore().iterateNodesByType(typeName)) {\n        this.trackInlineObjectsInRootNode(node)\n        const resolvedFields = await resolveRecursive(\n          this,\n          this.schemaComposer,\n          this.schema,\n          node,\n          type,\n          queryFields,\n          actualFieldsToResolve\n        )\n        if (!node.__gatsby_resolved) {\n          node.__gatsby_resolved = {}\n        }\n        resolvedNodes.set(\n          node.id,\n          _.merge(node.__gatsby_resolved, resolvedFields)\n        )\n      }\n      if (resolvedNodes.size) {\n        await saveResolvedNodes(typeName, resolvedNodes)\n      }\n      this._preparedNodesCache.set(\n        typeName,\n        _.merge(\n          {},\n          this._preparedNodesCache.get(typeName) || {},\n          actualFieldsToResolve\n        )\n      )\n    }\n  }\n\n  /**\n   * Get the names of all node types in the store.\n   *\n   * @returns {string[]}\n   */\n  getTypes() {\n    return getTypes()\n  }\n\n  /**\n   * Adds link between inline objects/arrays contained in Node object\n   * and that Node object.\n   * @param {Node} node Root Node\n   */\n  trackInlineObjectsInRootNode(node) {\n    if (!this._trackedRootNodes.has(node)) {\n      addRootNodeToInlineObject(\n        this._rootNodeMap,\n        node,\n        node.id,\n        true,\n        new Set()\n      )\n      this._trackedRootNodes.add(node)\n    }\n  }\n\n  /**\n   * Finds top most ancestor of node that contains passed Object or Array\n   * @param {(Object|Array)} obj Object/Array belonging to Node object or Node object\n   * @param {nodePredicate} [predicate] Optional callback to check if ancestor meets defined conditions\n   * @returns {Node} Top most ancestor if predicate is not specified\n   * or first node that meet predicate conditions if predicate is specified\n   */\n  findRootNodeAncestor(obj, predicate = null) {\n    let iterations = 0\n    let node = obj\n\n    while (iterations++ < 100) {\n      if (predicate && predicate(node)) return node\n\n      const parent = getNodeById(node.parent)\n      const id = this._rootNodeMap.get(node)\n      const trackedParent = getNodeById(id)\n\n      if (!parent && !trackedParent) {\n        const isMatchingRoot = !predicate || predicate(node)\n        return isMatchingRoot ? node : null\n      }\n\n      node = parent || trackedParent\n    }\n\n    reporter.error(\n      `It looks like you have a node that's set its parent as itself:\\n\\n` +\n        node\n    )\n    return null\n  }\n\n  /**\n   * Given a result, that's either a single node or an array of them, track them\n   * using pageDependencies. Defaults to tracking according to current resolver\n   * path. Returns the result back.\n   *\n   * @param {Node | Node[]} result\n   * @param {PageDependencies} [pageDependencies]\n   * @returns {Node | Node[]}\n   */\n  trackPageDependencies(result, pageDependencies = {}) {\n    const { path, connectionType, track = true } = pageDependencies\n    if (path && track) {\n      if (connectionType) {\n        this.createPageDependency({ path, connection: connectionType })\n      } else {\n        const nodes = isIterable(result) ? result : [result]\n        for (const node of nodes) {\n          if (node) {\n            this.createPageDependency({ path, nodeId: node.id })\n          }\n        }\n      }\n    }\n\n    return result\n  }\n}\n\nclass ContextualNodeModel {\n  constructor(rootNodeModel, context) {\n    this.nodeModel = rootNodeModel\n    this.context = context\n  }\n\n  withContext(context) {\n    return new ContextualNodeModel(this.nodeModel, {\n      ...this.context,\n      ...context,\n    })\n  }\n\n  _getFullDependencies(pageDependencies) {\n    return {\n      path: this.context.path,\n      ...(pageDependencies || {}),\n    }\n  }\n\n  getNodeById(args, pageDependencies) {\n    return this.nodeModel.getNodeById(\n      args,\n      this._getFullDependencies(pageDependencies)\n    )\n  }\n\n  getNodesByIds(args, pageDependencies) {\n    return this.nodeModel.getNodesByIds(\n      args,\n      this._getFullDependencies(pageDependencies)\n    )\n  }\n\n  getAllNodes(args, pageDependencies) {\n    return this.nodeModel.getAllNodes(\n      args,\n      this._getFullDependencies(pageDependencies)\n    )\n  }\n\n  runQuery(args, pageDependencies) {\n    return this.nodeModel.runQuery(\n      args,\n      this._getFullDependencies(pageDependencies)\n    )\n  }\n\n  findOne(args, pageDependencies) {\n    return this.nodeModel.findOne(\n      args,\n      this._getFullDependencies(pageDependencies)\n    )\n  }\n\n  findAll(args, pageDependencies) {\n    return this.nodeModel.findAll(\n      args,\n      this._getFullDependencies(pageDependencies)\n    )\n  }\n\n  prepareNodes(...args) {\n    return this.nodeModel.prepareNodes(...args)\n  }\n\n  getTypes(...args) {\n    return this.nodeModel.getTypes(...args)\n  }\n\n  trackInlineObjectsInRootNode(...args) {\n    return this.nodeModel.trackInlineObjectsInRootNode(...args)\n  }\n\n  findRootNodeAncestor(...args) {\n    return this.nodeModel.findRootNodeAncestor(...args)\n  }\n\n  createPageDependency(...args) {\n    return this.nodeModel.createPageDependency(...args)\n  }\n\n  trackPageDependencies(result, pageDependencies) {\n    return this.nodeModel.trackPageDependencies(\n      result,\n      this._getFullDependencies(pageDependencies)\n    )\n  }\n}\n\nconst getNodeById = id => (id != null ? getNode(id) : null)\n\nconst toNodeTypeNames = (schema, gqlTypeName) => {\n  const gqlType =\n    typeof gqlTypeName === `string` ? schema.getType(gqlTypeName) : gqlTypeName\n\n  if (!gqlType) return []\n\n  const possibleTypes = isAbstractType(gqlType)\n    ? schema.getPossibleTypes(gqlType)\n    : [gqlType]\n\n  return possibleTypes\n    .filter(type => type.getInterfaces().some(iface => iface.name === `Node`))\n    .map(type => type.name)\n}\n\nconst getQueryFields = ({ filter, sort, group, distinct, max, min, sum }) => {\n  const filterFields = filter ? dropQueryOperators(filter) : {}\n  const sortFields = (sort && sort.fields) || []\n\n  if (group && !Array.isArray(group)) {\n    group = [group]\n  } else if (group == null) {\n    group = []\n  }\n\n  if (distinct && !Array.isArray(distinct)) {\n    distinct = [distinct]\n  } else if (distinct == null) {\n    distinct = []\n  }\n\n  if (max && !Array.isArray(max)) {\n    max = [max]\n  } else if (max == null) {\n    max = []\n  }\n\n  if (min && !Array.isArray(min)) {\n    min = [min]\n  } else if (min == null) {\n    min = []\n  }\n\n  if (sum && !Array.isArray(sum)) {\n    sum = [sum]\n  } else if (sum == null) {\n    sum = []\n  }\n\n  return _.merge(\n    filterFields,\n    ...sortFields.map(pathToObject),\n    ...group.map(pathToObject),\n    ...distinct.map(pathToObject),\n    ...max.map(pathToObject),\n    ...min.map(pathToObject),\n    ...sum.map(pathToObject)\n  )\n}\n\nconst pathToObject = path => {\n  if (path && typeof path === `string`) {\n    return path.split(`.`).reduceRight((acc, key) => {\n      return { [key]: acc }\n    }, true)\n  }\n  return {}\n}\n\nconst dropQueryOperators = filter =>\n  Object.keys(filter).reduce((acc, key) => {\n    const value = filter[key]\n    const k = Object.keys(value)[0]\n    const v = value[k]\n    if (_.isPlainObject(value) && _.isPlainObject(v)) {\n      acc[key] =\n        k === `elemMatch` ? dropQueryOperators(v) : dropQueryOperators(value)\n    } else {\n      acc[key] = true\n    }\n    return acc\n  }, {})\n\nconst getFields = (schema, type, node) => {\n  if (!isAbstractType(type)) {\n    return type.getFields()\n  }\n\n  const concreteType = type.resolveType(node)\n  return schema.getType(concreteType).getFields()\n}\n\nasync function resolveRecursive(\n  nodeModel,\n  schemaComposer,\n  schema,\n  node,\n  type,\n  queryFields,\n  fieldsToResolve\n) {\n  const gqlFields = getFields(schema, type, node)\n  const resolvedFields = {}\n  for (const fieldName of Object.keys(fieldsToResolve)) {\n    const fieldToResolve = fieldsToResolve[fieldName]\n    const queryField = queryFields[fieldName]\n    const gqlField = gqlFields[fieldName]\n    const gqlNonNullType = getNullableType(gqlField.type)\n    const gqlFieldType = getNamedType(gqlField.type)\n    let innerValue = await resolveField(\n      nodeModel,\n      schemaComposer,\n      schema,\n      node,\n      gqlField,\n      fieldName\n    )\n    if (gqlField && innerValue != null) {\n      if (\n        isCompositeType(gqlFieldType) &&\n        !(gqlNonNullType instanceof GraphQLList)\n      ) {\n        innerValue = await resolveRecursive(\n          nodeModel,\n          schemaComposer,\n          schema,\n          innerValue,\n          gqlFieldType,\n          queryField,\n          _.isObject(fieldToResolve) ? fieldToResolve : queryField\n        )\n      } else if (\n        isCompositeType(gqlFieldType) &&\n        _.isArray(innerValue) &&\n        gqlNonNullType instanceof GraphQLList\n      ) {\n        innerValue = await Promise.all(\n          innerValue.map(item =>\n            item == null\n              ? item\n              : resolveRecursive(\n                  nodeModel,\n                  schemaComposer,\n                  schema,\n                  item,\n                  gqlFieldType,\n                  queryField,\n                  _.isObject(fieldToResolve) ? fieldToResolve : queryField\n                )\n          )\n        )\n      }\n    }\n    if (innerValue != null) {\n      resolvedFields[fieldName] = innerValue\n    }\n  }\n\n  for (const fieldName of Object.keys(queryFields)) {\n    if (!fieldsToResolve[fieldName] && node[fieldName]) {\n      // It is possible that this field still has a custom resolver\n      // See https://github.com/gatsbyjs/gatsby/issues/27368\n      resolvedFields[fieldName] = await resolveField(\n        nodeModel,\n        schemaComposer,\n        schema,\n        node,\n        gqlFields[fieldName],\n        fieldName\n      )\n    }\n  }\n\n  return _.pickBy(resolvedFields, (value, key) => queryFields[key])\n}\n\nfunction resolveField(\n  nodeModel,\n  schemaComposer,\n  schema,\n  node,\n  gqlField,\n  fieldName\n) {\n  if (!gqlField?.resolve) {\n    return node[fieldName]\n  }\n  const withResolverContext = require(`./context`)\n  return gqlField.resolve(\n    node,\n    gqlField.args.reduce((acc, arg) => {\n      acc[arg.name] = arg.defaultValue\n      return acc\n    }, {}),\n    withResolverContext({\n      schema,\n      schemaComposer,\n      nodeModel,\n    }),\n    {\n      fieldName,\n      schema,\n      returnType: gqlField.type,\n    }\n  )\n}\n\nconst determineResolvableFields = (\n  schemaComposer,\n  schema,\n  type,\n  fields,\n  nodeTypeNames,\n  isNestedType = false\n) => {\n  const fieldsToResolve = {}\n  const gqlFields = type.getFields()\n  Object.keys(fields).forEach(fieldName => {\n    const field = fields[fieldName]\n    const gqlField = gqlFields[fieldName]\n    const gqlFieldType = getNamedType(gqlField.type)\n    const typeComposer = schemaComposer.getAnyTC(type.name)\n    const possibleTCs = [\n      typeComposer,\n      ...nodeTypeNames.map(name => schemaComposer.getAnyTC(name)),\n    ]\n    let needsResolve = false\n    for (const tc of possibleTCs) {\n      needsResolve = tc.getFieldExtension(fieldName, `needsResolve`) || false\n      if (needsResolve) {\n        break\n      }\n    }\n\n    if (_.isObject(field) && gqlField) {\n      const innerResolved = determineResolvableFields(\n        schemaComposer,\n        schema,\n        gqlFieldType,\n        field,\n        toNodeTypeNames(schema, gqlFieldType),\n        true\n      )\n      if (!_.isEmpty(innerResolved)) {\n        fieldsToResolve[fieldName] = innerResolved\n      }\n    }\n\n    if (!fieldsToResolve[fieldName] && needsResolve) {\n      fieldsToResolve[fieldName] = true\n    }\n    if (!fieldsToResolve[fieldName] && isNestedType) {\n      // If parent field needs to be resolved - all nested fields should be added as well\n      // See https://github.com/gatsbyjs/gatsby/issues/26056\n      fieldsToResolve[fieldName] = true\n    }\n  })\n  return fieldsToResolve\n}\n\nconst addRootNodeToInlineObject = (\n  rootNodeMap,\n  data,\n  nodeId,\n  isNode /* : boolean */,\n  path /* : Set<mixed> */\n) /* : void */ => {\n  const isPlainObject = _.isPlainObject(data)\n\n  if (isPlainObject || _.isArray(data)) {\n    if (path.has(data)) return\n    path.add(data)\n\n    _.each(data, (o, key) => {\n      if (!isNode || key !== `internal`) {\n        addRootNodeToInlineObject(rootNodeMap, o, nodeId, false, path)\n      }\n    })\n\n    // don't need to track node itself\n    if (!isNode) {\n      rootNodeMap.set(data, nodeId)\n    }\n  }\n}\n\nconst saveResolvedNodes = async (typeName, resolvedNodes) => {\n  store.dispatch({\n    type: `SET_RESOLVED_NODES`,\n    payload: {\n      key: typeName,\n      nodes: resolvedNodes,\n    },\n  })\n}\n\nconst deepObjectDifference = (from, to) => {\n  const result = {}\n  Object.keys(from).forEach(key => {\n    const toValue = to[key]\n    if (toValue) {\n      if (_.isPlainObject(toValue)) {\n        const deepResult = deepObjectDifference(from[key], toValue)\n        if (!_.isEmpty(deepResult)) {\n          result[key] = deepResult\n        }\n      }\n    } else {\n      result[key] = from[key]\n    }\n  })\n  return result\n}\n\nmodule.exports = {\n  LocalNodeModel,\n}\n"],"file":"node-model.js"}